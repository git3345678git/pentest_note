# registry persistence detection








# 註冊表持久性檢測


```
Username	Administrator
Password	Passw0rd!
IP	10.10.174.196
```

```
xfreerdp /u:Administrator /p:Passw0rd! /cert:ignore /v:10.10.174.196
```
## 介紹

惡意軟體可以透過多種方式獲得持久性。所使用的技術因目標作業系統、實施難易度、隱藏程度而異，有時還取決於惡意軟體作者的偏好。 這些技術的範例包括修改作業系統的開機磁區、安裝惡意設定或劫持執行流。

---

## 惡意軟體持久性機制簡介

**最容易實施的技術是濫用 Windows 登錄機碼執行鍵**
```
HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run
目前使用者登入時的執行路徑

HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run
任何使用者登入時的執行路徑

HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce
目前使用者登入時的執行路徑，然後刪除

HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnce
任何使用者登入時的執行路徑，然後刪除
```

**找到**
```
HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run
(Default) C:\Users\Administrator\AppData\Local\bd84\24d9.bat
```

---


## AutoRuns PowerShell 模組簡介


```
Get-Command -Module AutoRuns
```

**顯示3個模組**
```
Get-PSAutorun

New-AutoRunsBaseLine

Compare-AutoRunsBaseLine
```


---




## 過濾自動運行條目

**AutoRuns PowerShell 有一個名為Get-PSAutorun 的函數，它將列出電腦上所有可能的自動啟動機制。**

它透過查看註冊表、Windows 服務、WMI 條目、DLL 劫持等類別來製作此清單。
因此，命令的輸出將傳回許多結果，如果沒有充分過濾，這些結果可能會具有挑戰性。




**將上述命令的結果透過管道傳輸到Out-GridView cmdlet 可以使輸出更具可讀性。**
```
Get-PSAutorun | Out-GridView
```



**使用Get-Help命令列出可用參數。**
```
Get-Help Get-PSAutorun -detailed
```



**過濾與映像啟動執行相關的工件**
```
Get-PSAutorun -BootExecute | Out-GridView
```

```
Path          : HKLM:\System\CurrentControlSet\Control\Session Manager
Item          : BootExecute
Category      : Boot Execute
Value         : autocheck autochk /q /v *
ImagePath     : C:\Windows\system32\autochk.exe
Size          : 956416
LastWriteTime : 1/13/2021 9:15:12 PM
Version       : 10.0.17763.1697

```


**過濾與印表機驅動程式和狀態監視器相關的工件**
```
Get-PSAutorun -PrintMonitorDlls | Out-GridView
```
```
Path          : HKLM:\SYSTEM\CurrentControlSet\Control\Print\Monitors\Local Port
Item          : Driver
Category      : Print Monitors
Value         : localspl.dll
ImagePath     : C:\Windows\System32\localspl.dll
Size          : 1225216
LastWriteTime : 3/11/2021 9:15:38 AM
Version       : 10.0.17763.1

Path          : HKLM:\SYSTEM\CurrentControlSet\Control\Print\Monitors\Standard TCP/IP
                Port
Item          : Driver
Category      : Print Monitors
Value         : tcpmon.dll
ImagePath     : C:\Windows\System32\tcpmon.dll
Size          : 223232
LastWriteTime : 5/13/2020 5:54:27 PM
Version       : 10.0.17763.1

Path          : HKLM:\SYSTEM\CurrentControlSet\Control\Print\Monitors\USB Monitor
Item          : Driver
Category      : Print Monitors
Value         : usbmon.dll
ImagePath     : C:\Windows\System32\usbmon.dll
Size          : 359936
LastWriteTime : 1/13/2021 9:15:47 PM
Version       : 10.0.17763.1

Path          : HKLM:\SYSTEM\CurrentControlSet\Control\Print\Monitors\WSD Port
Item          : Driver
Category      : Print Monitors
Value         : APMon.dll
ImagePath     : C:\Windows\System32\APMon.dll
Size          : 1267712
LastWriteTime : 1/13/2021 9:15:47 PM
Version       : 10.0.17763.1

Path          : HKLM:\SYSTEM\CurrentControlSet\Control\Print\Providers\LanMan Print
                Services
Item          : Name
Category      : Print Monitors
Value         : win32spl.dll
ImagePath     : C:\Windows\System32\win32spl.dll
Size          : 847872
LastWriteTime : 1/13/2021 9:15:22 PM
Version       : 10.0.17763.1


```



**顯示檔案是否經過數位簽章**
```
Get-PSAutorun -VerifyDigitalSignature | Out-GridView 
```

**可以複製下來共3條 Signed列設定為false**
```
HKLM:\SOFTWARE\\Microsoft\Windows\CurrentVersion\Run		Logon	C:\Users\Administrator\AppData\Local\bd84\24d9.bat	C:\Users\Administrator\AppData\Local\bd84\24d9.bat	41	11/6/2022 12:57:37 PM		False		

HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon	Userinit	Logon	C:\Windows\system32\userinit.exe,C:\Users\Administrator\AppData\Local\THM\789a.bat	C:\Users\Administrator\AppData\Local\THM\789a.bat	40	11/6/2022 12:57:56 PM		False		


HKLM:\System\CurrentControlSet\Services\cfn-hup	ImagePath	Services	"C:\Program Files\Amazon\cfn-bootstrap\winhup.exe"	C:\Program Files\Amazon\cfn-bootstrap\winhup.exe	40960	3/3/2021 9:20:14 PM		False			
```


**而不使用 Out-GridView 來回答上一個問題**
```
Get-PSAutorun -VerifyDigitalSignature | Where-Object { $_.Signed -eq $false } 
```


---


## 基線比較

雖然透過參數開關進行過濾有助於減少輸出，但仍有許多工作要做。這就是 AutoRuns PowerShell 模組的基線建立和比較功能有用的地方，因為結果中僅顯示與基線不同的條目。



**作者在建立環境時，在2022年已經創立了一個檔案**
PSAutoRunsBaseLine-20221106123440


**建立新的基線(檔案)**
```
Get-PSAutorun -VerifyDigitalSignature | Where-Object { -not $_.isOSbinary } | New-AutoRunsBaseLine -Verbose
```


**對比兩個基線**
```
Compare-AutoRunsBaseLine -Verbose | Out-GridView
```



**找到其中一個可疑的**
```
HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon	

Userinit	

Logon	

C:\Windows\system32\userinit.exe,C:\Users\Administrator\AppData\Local\THM\789a.bat

C:\Users\Administrator\AppData\Local\THM\789a.bat	40	11/6/2022 12:57:56 PM								


```





## 結論

**分別清除兩個檔案，在修改登入檔，對比發現沒有了**
```
HKLM:\SOFTWARE\\Microsoft\Windows\CurrentVersion\Run

Logon	

C:\Users\Administrator\AppData\Local\bd84\24d9.bat

C:\Users\Administrator\AppData\Local\bd84\24d9.bat	41	11/6/2022 12:57:37 PM								=>	




HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon	

Userinit	

Logon	

C:\Windows\system32\userinit.exe,C:\Users\Administrator\AppData\Local\THM\789a.bat

C:\Users\Administrator\AppData\Local\THM\789a.bat	40	11/6/2022 12:57:56 PM								=>	
							=>	

```
