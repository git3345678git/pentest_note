# Nmap 端口掃描技術

## 資源
```
https://svn.nmap.org/nmap/docs/nmap.usage.txt
https://nmap.org/book/man-port-scanning-techniques.html
https://www.keepnight.com/archives/1423/
```


## 部份使用方法
```
SCAN TECHNIQUES:
  -sS/sT/sA/sW/sM: TCP SYN/Connect()/ACK/Window/Maimon scans
  -sU: UDP Scan
  -sN/sF/sX: TCP Null, FIN, and Xmas scans
  --scanflags <flags>: Customize TCP scan flags
  -sI <zombie host[:probeport]>: Idle scan
  -sY/sZ: SCTP INIT/COOKIE-ECHO scans
  -sO: IP protocol scan
```


```
### open
開放


### closed
關閉的連接埠可以存取（它接收並回應 Nmap 探測資料包），但沒有應用程式偵聽該連接埠
由於關閉的連接埠是可存取的，因此可能值得稍後掃描



### filtered
過濾可以來自專用防火牆設備
路由器規則或基於主機的防火牆軟體
這些連接埠讓攻擊者感到沮喪



### unfiltered
意味著連接埠可以訪問

無法確定該連接埠是開啟還是關閉

只有用於對應防火牆規則集的 ACK 掃描才會將連接埠分類為此狀態
其他掃描類型（例如視窗掃描、SYN 掃描或 FIN 掃描）掃描未過濾的連接埠可能有助於確定連接埠是否已開啟



### open|filtered
無法確定連接埠是開放還是已過濾
對於開放連接埠沒有回應的掃描類型，會發生這種情況
缺乏響應也可能意味著資料包過濾器丟棄了探測或其引發的任何響應
UDP、IP 協定、FIN、NULL 和 Xmas 掃描 會出現這種情況


### closed|filtered
当Nmap在进行IP ID空闲扫描时，如果无法确定目标主机上的端口是关闭的还是被过滤的，
就会将这些端口标记为 "closed|filtered" 状态。
这种状态表示Nmap无法确定端口的确切状态，
可能是因为目标主机对所有端口的扫描请求采取了相同的响应方式，
无论端口是关闭还是被过滤
```




## -sS (TCP SYN 掃描)

```
TCP SYN掃描，也稱為半開放掃描。它向目標主機發送TCP SYN封包，觀察是否收到SYN/ACK回應，以確定端口是否開放。

sudo nmap -sS -p80 192.168.50.46 
```

## -sT TCP掃描，
```
也稱為全開放掃描。它通過建立完整的TCP連接來確定端口是否開放。

sudo nmap -sT  192.168.50.46 
sudo nmap -sT -p80 192.168.50.46 
```



## -sA 

```
TCP ACK掃描，僅發送TCP ACK封包，用於網絡防火牆規則檢查

此掃描與迄今為止討論的其他掃描不同，因為它從不確定open（甚至 open|filtered）連接埠。它用於映射防火牆規則集，確定它們是否有狀態以及過濾哪些連接埠。

防火牆規則集映射：ACK掃描用於識別防火牆規則集，確定它們是有狀態的還是無狀態的，以及哪些端口被過濾了。

確定未過濾的端口：當掃描未過濾的系統時，開放和關閉的端口都會返回一個RST封包，Nmap將它們標記為未過濾，這意味著它們可以被ACK封包訪問，但是它們是開放還是關閉的尚不確定。

標記過濾的端口：不回應或返回特定的ICMP錯誤消息（類型3，代碼0、1、2、3、9、10或13）的端口會被標記為過濾。

sudo nmap -sA  192.168.50.46 
sudo nmap -sA -p80 192.168.50.46 
```



## -sW（TCP視窗掃描）

```
TCP Window掃描（-sW選項）：它與ACK掃描相似，但利用特定系統的實現細節來區分開放端口和關閉端口。它通過檢查返回的RST封包的TCP Window字段來實現這一點。

開放端口和關閉端口的區分：在某些系統上，開放的端口使用正的窗口大小，即使對於RST封包也是如此，而關閉的端口則具有零窗口。

結果解釋：不像ACK掃描總是將端口列為未過濾（unfiltered），TCP Window掃描將端口列為開放或關閉，具體取決於重設（RST）封包中的TCP Window值是正還是零。

不可信賴性：該掃描依賴於互聯網上少數系統的實現細節，因此不能始終信任。不支持此掃描的系統通常會返回所有端口關閉。

可能性分析：有時機器真的沒有開放的端口，但如果大多數端口都關閉，而一些常見端口（如22、25、53）被過濾，那麼系統很可能易受攻擊。有時系統甚至會顯示完全相反的行為。


sudo nmap -sW  192.168.50.46
sudo nmap -sW -p80 192.168.50.46
```


## -sM（TCP邁蒙掃描）

```
TCP Maimon掃描（-sM選項）：該掃描以其發現者Uriel Maimon命名，他在Phrack Magazine第49期（1996年11月）中描述了這種技術。Nmap在隨後的兩期中發布了包含此技術的版本。Maimon掃描與NULL、FIN和Xmas掃描完全相同，唯一的區別是探測封包是FIN/ACK。

RFC 793（TCP）的規定：根據RFC 793（TCP）的規定，無論端口是開放還是關閉，都應該生成RST封包來回應這樣的探測封包。

BSD衍生系統的行為：Uriel注意到許多基於BSD的系統如果端口是開放的，則簡單地丟棄這個封包，而不是生成RST封包。


sudo nmap -sM  192.168.50.46 --packet-trace
sudo nmap -sM  -p80 192.168.50.46 --packet-trace
```

## -sU（UDP 掃描 )


```
1. **UDP掃描的工作原理**：UDP掃描通過向每個目標連接埠發送UDP封包來進行。對於一些常見端口（如53和161），會使用特定於協議的有效負載以提高響應速度，否則封包通常為空。

2. **連接埠狀態的判斷**：根據返回的ICMP消息來判斷連接埠的狀態。如果收到ICMP連接埠不可達錯誤（類型3，代碼3），則該連接埠被標記為closed；其他ICMP不可達錯誤（類型3，代碼0、1、2、9、10或13）將連接埠標記為filtered。有時服務會用UDP封包進行回應，證明連接埠是open。如果在重傳後沒有收到回應，則該連接埠被分類為open|filtered，表示連接埠可能是開放的，也可能被資料包過濾器過濾。



3. **掃描速度挑戰**：UDP掃描的一個挑戰是快速完成掃描。開放和過濾的連接埠通常不發送任何回應，導致Nmap逾時並進行重新傳輸，以防止探測或回應丟失。

4. **關閉連接埠的挑戰**：關閉的連接埠通常會發回ICMP連接埠不可達錯誤消息。但與關閉TCP連接埠對SYN或連線掃描發送的RST封包不同，許多主機默認對ICMP連接埠不可達消息進行速率限制。

5. **Nmap的速度控制**：Nmap會檢測到速率限制並相應減慢速度，以避免目標電腦丟棄的無用資料包淹沒網路。

6. **加速UDP掃描的方法**：加速UDP掃描的方法包括並行掃描更多主機、首先快速掃描常用連接埠、從防火牆後面掃描以及使用--host-timeout跳過慢速主機。

幸的是，Linux 風格的每秒一個資料包的限制使得 65,536 個連接埠掃描需要超過 18 個小時。加快 UDP 掃描速度的想法包括並行掃描更多主機、首先快速掃描常用連接埠、從防火牆後面掃描以及用於--host-timeout跳過慢速主機。

sudo nmap -sU   192.168.50.46 --packet-trace
sudo nmap -sU  -p80 192.168.50.46 --packet-trace

#針對Linux 掃少一點port 減少時間
sudo nmap -sU   192.168.50.1 --packet-trace --top-ports 10


#檢測服務
sudo nmap -sU   192.168.50.1 --packet-trace -p67 -sV


```



## -sN -sF -sX



```
1. **-sN**: TCP Null掃描。在Null掃描中，不設置TCP標誌，這意味著它是一個空的（null）掃描。這種方法利用了TCP協議的某些規範上的漏洞，用於識別目標主機上的開放端口。如果端口是開放的，目標主機通常會忽略Null掃描，不發送任何回應；如果端口是關閉的，目標主機可能會發送一個RST封包作為回應。

2. **-sF**: TCP FIN掃描。FIN掃描是一種利用TCP協議的FIN標誌的掃描技術。通常情況下，如果目標端口是開放的，目標主機會忽略這樣的掃描；如果端口是關閉的，目標主機可能會發送一個RST封包作為回應。

3. **-sX**: TCP Xmas Tree掃描。Xmas Tree掃描類似於FIN掃描，但除了FIN標誌外，還設置了PSH（Push）和URG（Urgent）標誌。這些標誌一起創建了一個“聖誕樹”的形狀，因此得名。與Null和FIN掃描一樣，如果目標端口是開放的，通常會忽略Xmas Tree掃描，不發送任何回應；如果端口是關閉的，可能會發送一個RST封包作為回應。

這些掃描類型的主要優點是它們可以潛入某些非狀態防火牆和封包過濾路由器。
另一個優點是這些掃描類型比 SYN 掃描更隱密。
不過，不要指望這一點——大多數現代 IDS 產品都可以配置為檢測它們。最大的缺點是並非所有系統都嚴格遵循 RFC 793。無論連接埠是否開啟，許多系統都會向偵測器發送 RST 回應。

這會導致所有連接埠都被標記closed。執行此操作的主要作業系統有 Microsoft Windows、許多 Cisco 設備、BSDI 和 IBM OS/400。

* 不過，這種掃描確實適用於大多數基於 Unix 的系統。*

這些掃描的另一個缺點是它們無法區分open端口和某些filtered端口，從而給您留下響應 open|filtered。



sudo nmap   -sN   192.168.50.1
sudo nmap   -sF   192.168.50.1
sudo nmap   -sX  192.168.50.1
```



## -sY/sZ

```
-sY: SCTP INIT掃描。SCTP（Stream Control Transmission Protocol）是一種可靠的傳輸控制協議，
用於在網際網路上傳輸數據。在SCTP INIT掃描中，Nmap向目標主機的指定端口發送SCTP INIT封包，
並觀察目標主機的回應來識別端口的狀態。這種掃描類似於TCP SYN掃描，用於識別SCTP服務的開放端口。

-sZ: SCTP COOKIE-ECHO掃描。在SCTP COOKIE-ECHO掃描中，Nmap向目標主機的指定端口發送SCTP COOKIE-ECHO封包，
並觀察目標主機的回應來識別端口的狀態。這種掃描類似於TCP NULL掃描，用於識別SCTP服務的開放端口。

這些SCTP掃描方法用於識別目標主機上運行的SCTP服務的開放端口。需要注意的是，SCTP通常用於某些特定應用程序或服務，
而不像TCP和UDP那樣廣泛使用，因此對於一般的網絡掃描來說，這些SCTP掃描可能不太常見。



sudo nmap   -sY  192.168.50.1
sudo nmap   -sZ  192.168.50.1
```


## -sO（IP協定掃描）

```
IP 協定掃描可讓您確定目標電腦支援哪些 IP 協定（TCP、ICMP、IGMP 等）。從技術上講，這不是連接埠掃描，因為它循環遍歷 IP 協定號而不是 TCP 或 UDP 連接埠號碼。然而，它仍然使用該 -p選項來選擇掃描的協定號，以正常的連接埠表格式報告其結果，甚至使用與真正的連接埠掃描方法相同的底層掃描引擎。因此它與連接埠掃描足夠接近

sudo nmap   -sO  192.168.50.1
```



## 其他選項

```
-p <port ranges>：僅掃描指定的端口範圍。
例如：-p22 表示僅掃描端口22；-p1-65535 表示掃描所有端口；

-p- 所有端口
sudo nmap -p- -sS 192.168.50.46





--exclude-ports <port ranges>：排除指定的端口範圍，不進行掃描。
sudo nmap --top-ports 100 192.168.50.46 --exclude-ports 80





-F：快速模式 - 比默認掃描少掃描一些端口。
sudo nmap -F  192.168.50.46 



-r：按順序掃描端口 - 不隨機化。
sudo nmap -p22-30  192.168.50.46  -r



--top-ports <number>：掃描最常見的 <number> 個端口。
sudo nmap --top-ports 10  192.168.50.46  





--port-ratio <ratio>：掃描比 <ratio> 更常見的端口。
sudo nmap --port-ratio 0.01  192.168.50.46  


```





