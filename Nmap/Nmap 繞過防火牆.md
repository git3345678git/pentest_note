# Nmap 繞過防火牆

###### tags: `Nmap`

有時產生大量報文，或是同一IP容易被ban，這時可以用一些參數



好文

https://minmin0625.medium.com/%E6%BB%B2%E9%80%8F%E6%B8%AC%E8%A9%A6lab-nmap-part3-%E7%AB%AF%E5%8F%A3%E6%8E%83%E6%8F%8F-port-scanning-2f51645f3323

https://blog.csdn.net/weixin_46236101/article/details/112303277

https://blog.csdn.net/weixin_46236101/article/details/112303277

https://www.cnblogs.com/bulh/articles/16635381.html

---






### 碎片掃描
Nmap發送8個字節的數據包繞過防火牆/IDS/IPS。
```
sudo nmap -f 192.168.43.96

```



使用16字節的數據包,我們可以指定自定義數據包大小為8的倍數。
```
sudo nmap --mtu 16 192.168.43.96
```



-f（片段數據包）； --mtu（使用指定的 MTU）
這-f選項導致請求的掃描（包括主機發現掃描）使用微小的碎片 IP 數據包。這個想法是將 TCP 標頭拆分為多個數據包，使數據包過濾器、入侵檢測系統和其他煩人的東西更難檢測到你在做什麼。小心這個！一些程序在處理這些小數據包時遇到問題。名為 Sniffit segmentation 的老派嗅探器在收到第一個片段後立即出錯。指定此選項一次，Nmap 將數據包拆分為 IP 標頭後的八個字節或更少。因此，一個 20 字節的 TCP 標頭將被分成三個數據包。兩個包含八個字節的 TCP 標頭，一個包含最後四個字節。當然每個片段也有一個 IP 頭。指定-f再次使用每個片段 16 個字節（減少片段的數量）。或者您可以使用該--mtu選項指定您自己的偏移量大小。如果-f您使用--mtu. 偏移量必須是八的倍數。雖然碎片化的數據包不會通過將所有 IP 碎片排隊的數據包過濾器和防火牆（例如CONFIG_IP_ALWAYS_DEFRAGLinux 內核中的選項），但一些網絡無法承受由此導致的性能損失，因此將其禁用。其他人無法啟用此功能，因為片段可能會採用不同的路由進入他們的網絡。一些源系統在內核中對傳出數據包進行碎片整理。帶有 iptables 的 Linux 連接跟踪模塊就是這樣一個例子。在Wireshark等嗅探器運行時進行掃描 ，以確保發送的數據包是分段的。如果您的主機操作系統導致問題，請嘗試 --send-eth 繞過 IP 層並發送原始以太網幀的選項。

只有 Nmap 的原始數據包功能支持分片，包括 TCP 和 UDP 端口掃描（連接掃描和 FTP 反彈掃描除外）和操作系統檢測。版本檢測和 Nmap 腳本引擎等功能通常不支持分段，因為它們依賴主機的 TCP 堆棧與目標服務進行通信。






### 誘餌掃描
目標由多個假冒或偽造IP地址進行掃描。這樣防火牆就會認為攻擊或掃描是通過多個資源或IP地址進行

```
sudo nmap -D RND:10 192.168.43.96
sudo nmap -D 192.168.43.5,192.168.43.6(誘餌主機) 192.168.43.96(目標)
```


導致執行誘餌掃描，這使遠程主機看起來您指定為誘餌的主機也在掃描目標網絡。因此，他們的 IDS 可能會報告來自唯一 IP 地址的 5-10 端口掃描，但他們不知道哪個 IP 正在掃描他們，哪些是無辜的誘餌。雖然這可以通過路由器路徑跟踪、響應丟棄和其他主動機制來解決，但它通常是隱藏 IP 地址的有效技術。

用逗號分隔每個誘餌主機，您可以選擇使用 ME 其中一個誘餌來代表您的真實 IP 地址的位置。如果您放在 ME第六位或更靠後的位置，一些常見的端口掃描檢測器（例如 Solar Designer 出色的 Scanlogd） 根本不可能顯示您的 IP 地址。如果你不使用ME，Nmap 會把你放在一個隨機的位置。您還可以使用它 RND 來生成一個隨機的、非保留的 IP 地址，或者生成地址。 RND:<number><number>

請注意，您用作誘餌的主機應該已啟動，否則您可能會意外地通過 SYN 淹沒您的目標。如果網絡上只有一台主機，那麼確定哪台主機正在掃描也很容易。您可能希望使用 IP 地址而不是名稱（這樣誘餌網絡就不會在其名稱服務器日誌中看到您）。目前隨機 IP 地址生成僅支持 IPv4

誘餌用於初始主機發現掃描（使用 ICMP、SYN、ACK 或其他）和實際端口掃描階段。誘餌也用於遠程操作系統檢測 ( -O)。誘餌不適用於版本檢測或 TCP 連接掃描。當掃描延遲生效時，延遲是在每批欺騙探針之間強制執行的，而不是在每個單獨的探針之間。由於誘餌是一次性成批發送的，因此它們可能會暫時違反擁塞控制限制。

值得注意的是，使用過多的誘餌可能會減慢掃描速度，甚至可能降低掃描的準確性。此外，一些 ISP 會過濾掉您的欺騙性數據包，但許多 ISP 根本不限制欺騙性 IP 數據包。

---
    








### 隨機數據長度
改變發生數據包的默認的長度，避免被識別出來是nmap發送的。
    
    
    
```
nmap --data-length 25 192.168.43.96
```






### 參數選項–source-port
    
  
針對防火牆只允許的源端口
利用防火牆的弱點。端口21（FTP），端口53（DNS）和67（DHCP）是這種掃描類型的常見端口。
    
```
nmap --source-port 21 192.168.1.1
```



### 隨機順序

nmap --randomize-hosts  192.168.43.217

告訴 Nmap 在掃描它們之前將每組最多 16384 台主機洗牌。這可以使掃描對各種網絡監控系統來說不那麼明顯，尤其是當您將它與慢速計時選項結合使用時。如果您想隨機化更大的組大小，請增加 PING_GROUP_SZ 並nmap.h 重新編譯。另一種解決方案是使用列表掃描 ( ) 生成目標 IP 列表，使用 Perl 腳本將其隨機化，然後使用 將整個列表提供給 Nmap 。 -sL -n -oN <filename>-iL




### 空閒掃描
https://www.freebuf.com/column/172640.html

要先尋找網上空閒主機

```
nmap -Pn -sI <zombie host> <target>
nmap -Pn -sI 192.168.43.1 192.168.43.96
```



-sI <zombie host[:probeport]>: Idle scan

-Pn: Treat all hosts as online -- skip host discovery