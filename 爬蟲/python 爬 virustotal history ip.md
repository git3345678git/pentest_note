# 分析 virustotal history ip




## 瀏覽器工具觀察。

### 1. 切換到無痕窗口

在瀏覽器中，直接打開網站時，會自動攜帶之前網站保存的 Cookie。但在爬蟲中，首次獲取頁面時是沒有攜帶 Cookie 的。這時就需要使用無痕窗口。

### 2.1 保留日誌（Preserve log）

默認情況下，頁面跳轉後，之前的請求（之前抓的包）信息就會消失。勾選 "Preserve log" 後，之前的請求就都會被保留下來。

### 2.2 過濾器（Filter）

在 URL 地址很多的情況下，可以在過濾器中輸入部分 URL 地址，對所有的 URL 地址起到一定的過濾效果。

### 2.3 觀察特定種類的請求

有些選項默認選擇的是 "All"，即會觀察到所有種類的請求。有時候可以按自己的需求，選擇其他選項：

- XHR：大部分情況表示 AJAX 請求
- JS：JavaScript 請求
- CSS：CSS 請求


### 2.4 disable cache


1. **實時測試更改：** 在開發網站時，如果你對代碼進行了更改，但瀏覽器使用了之前存儲的快取版本，這可能會導致你看到的不是最新的網站狀態。禁用快取可以確保你每次查看網站時都是最新的版本，這對於實時測試和調試很重要。

2. **避免緩存問題：** 有時候，瀏覽器快取可能會導致一些問題，例如資源更新不及時或請求返回錯誤的快取版本。禁用快取可以幫助你排除這些與緩存相關的問題。

3. **模擬新用戶體驗：** 禁用快取可以讓你模擬新用戶訪問網站的體驗，因為新用戶通常不會有任何緩存資源。


### 善用request payload 的 show more選項



## 快速定位 

- burpsuite or owasp zap  修改包，或是快速抓取特定資料，

```
這邊推薦zap 因為如果我沒搞錯的話，他的搜尋功能不需要錢。

首先把  https://www.virustotal.com   include in context。

然後下方 history 跟 搜尋 欄位不錯用，兩個欄位都有支持過慮 只抓取 in context (in scope)，記得點擊
左邊 search only urls in scope
 
 
假設我尋找某個url請求
https://www.virustotal.com/gui/ip-address/104.238.221.221/relations

他會發出很多封包，我不知道哪個才是我要的封包

可以定位頁面上的字串 假設 'benevian.com'，可以用這個字串來定位請求。(超好用)


找到URL 
https://www.virustotal.com/ui/ip_addresses/104.238.221.221/resolutions


```


## js 逆向

- 当我们抓取网页端数据时，经常被加密参数、加密数据所困扰，如何快速定位这些加解密函数

這邊有精華
https://zhuanlan.zhihu.com/p/108207751


其中有個比較關鍵的http header ，X-VT-Anti-Abuse-Header 他每次的值都不一樣。


```
GET https://www.virustotal.com/ui/ip_addresses/104.238.221.221/resolutions HTTP/1.1
host: www.virustotal.com
User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:109.0) Gecko/20100101 Firefox/115.0
Accept: application/json
Accept-Language: zh-TW,zh;q=0.8,en-US;q=0.5,en;q=0.3
Referer: https://www.virustotal.com/
content-type: application/json
X-Tool: vt-ui-main
x-app-version: v1x262x2
Accept-Ianguage: en-US,en;q=0.9,es;q=0.8
X-VT-Anti-Abuse-Header: MTk5NDEyNTUwNjMtWkc5dWRDQmlaU0JsZG1scy0xNzE1NTAzMDA2LjA4MQ==
Connection: keep-alive
Cookie: _ga_BLNDV9X2JR=GS1.1.1715496812.9.1.1715498761.0.0.0; _ga=GA1.1.2090433141.1715344724; _gid=GA1.2.1509668822.1715344726; __gsas=ID=20503b8bb9ab2f3b:T=1715344728:RT=1715344728:S=ALNI_MYcyBounuizPauG-SIroro0TbIf_A
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-origin
Pragma: no-cache
Cache-Control: no-cache
content-length: 0


```


### 抓取三次找規律
```
X-VT-Anti-Abuse-Header: MTI3NTIyMzUwODUtWkc5dWRDQmlaU0JsZG1scy0xNzE1NDk4NzY3LjEzOQ==

X-VT-Anti-Abuse-Header: MTk5NDEyNTUwNjUtWkc5dWRDQmlaU0JsZG1scy0xNzE1NTAzMDA2LjA4OQ==


X-VT-Anti-Abuse-Header: MTI0NjY3ODg5NjgtWkc5dWRDQmlaU0JsZG1scy0xNzE1NTAzMDE4Ljk5OA==
```





### base64解密

```
12752235085-ZG9udCBiZSBldmls-1715498767.139

12466788968-ZG9udCBiZSBldmls-1715503018.998

19941255065-ZG9udCBiZSBldmls-1715503006.089


其中1715498767.139  1715503018.998  1715503006.089
是unix times tamp 格式

但是ZG9udCBiZSBldmls 前面被加上特殊規則


```


### 我們自己亂創一個看看會怎樣
測試結果可以成功。
```

19941255064-ZG9udCBiZSBldmls-1715503006.081
MTk5NDEyNTUwNjQtWkc5dWRDQmlaU0JsZG1scy0xNzE1NTAzMDA2LjA4OQ==


19941255063-ZG9udCBiZSBldmls-1715503006.081
MTk5NDEyNTUwNjMtWkc5dWRDQmlaU0JsZG1scy0xNzE1NTAzMDA2LjA4MQ==


18931255063-ZG9udCBiZSBldmls-1715503006.045
MTg5MzEyNTUwNjMtWkc5dWRDQmlaU0JsZG1scy0xNzE1NTAzMDA2LjA0NQ==

```


### 思路 

- 所以其實這個標頭形同虛設，我們可以亂產生相同格式繞過。

- JS逆向，尋找相關函數產生數值(比較正規)



### 實戰JS逆向

以上線索提供兩個值，給我們搜索
- X-VT-Anti-Abuse-Header
- ZG9udCBiZSBldmls




#### 先用zap 從JS中尋找相關代碼
```
找到
https://www.virustotal.com/gui/main.9ae64e57fa26346fccc2.js
```



#### 打開google f12 過濾器



- 搜尋main.9ae64e57fa26346fccc2.js  
- 右鍵 open in source panel 
- 點選左下角{}圖標 可以排版


- 搜索以下兩個
```
X-VT-Anti-Abuse-Header
ZG9udCBiZSBldmls (關鍵是這個)
```



#### 找到以下函數
```
computeAntiAbuseHeader() {
    const e = Date.now() / 1e3;
    return btoa(`${(()=>{
        const e = 1e10 * (1 + Math.random() % 5e4);
        return e < 50 ? "-1" : e.toFixed(0)
    }
    )()}-ZG9udCBiZSBldmls-${e}`)
}
```

#### 更改名子，加上function，並用console執行

```
function s() {
    const e = Date.now() / 1e3;
    return btoa(`${(()=>{
        const e = 1e10 * (1 + Math.random() % 5e4);
        return e < 50 ? "-1" : e.toFixed(0)
    }
    )()}-ZG9udCBiZSBldmls-${e}`)
}

s()

```

#### 輸出
```
MTU4MzU0MzQzMzMtWkc5dWRDQmlaU0JsZG1scy0xNzE1NTA2MTk2LjM3Mw==
```

#### decode 得到數值
```
15835434333-ZG9udCBiZSBldmls-1715506196.373
```



### 最後可以開始寫腳本了