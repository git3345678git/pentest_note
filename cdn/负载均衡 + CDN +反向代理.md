# 负载均衡 + CDN + VPN




一个域名可以对应多个IP吗？如何通过DNS实现

此文給了很好的答案。
https://zhuanlan.zhihu.com/p/586045593



NS服务器中配置三个A记录，分别为

www.example.com IN A 114.100.20.201;

www.example.com IN A 114.100.20.202;

www.example.com IN A 114.100.20.203;



## 当使用DNS进行负载均衡时，有以下优势：

- 省去了网站管理维护负载均衡服务器的麻烦；
- 技术实现比较灵活，操作简单，成本低，适用于大多数TCP/IP应用；
- 对于部署在服务器上的应用来说，不需要修改任何代码就能实现不同机器上的应用访问；
- 很多DNS系统还支持基于地理位置的域名解析，可以将域名解析成距离用户地理位置最近的服务器地址，加快用户访问速度。


## 基于DNS的负载均衡同样也存在一些弊端：

1. 目前的DNS系统是需要经过递归服务器、顶级服务器、权威服务器以及众多缓存等多级解析的，在每一个环节都可能存在解析记录缓存。如果服务器IP发生变动，即使修改了A记录，也需要各级缓存失效后才能生效。而在解析生效前的这段时间，用户可能就会根据缓存记录访问到已经被更换过的服务器上，从而导致访问失败。  

2. DNS负载均衡采用的是简单的轮询算法，不能区分不同服务器之间的性能和负载差异，不能反映服务器当前的运行状态，所以负载均衡效果并不太好。  

3. 为了本地DNS服务器能够及时同步权威服务器上的最新记录，所以一般将DNS缓存刷新时间设置得比较小，这就会导致DNS频繁发起解析请求，从而造成额外的网络问题。  


## 總結


DNS多个A记录可以用作负载均衡的第一层，以将流量分发到不同的服务器上。

而这些A记录所指向的实际服务器可以是NGINX等负载均衡软件或服务。

NGINX可以配置为在后端的多个服务器之间分发流量，以确保高可用性和性能。

因此，结合使用DNS和NGINX等负载均衡技术可以实现灵活而高效的负载均衡方案。




## 常見反向代理軟體

```
Nginx、Tengine
Apache HTTP Server
Varnish cache
Squid Cache
Traffic Server
HAProxy
YXORP
Polipo
Privoxy
IIS
Caddy
```


架構，使用說明
https://cloud.tencent.com/developer/article/1026991
https://blog.51cto.com/u_14449541/2460625
https://www.cnblogs.com/you-men/p/13022063.html







要確定對方是否使用反向代理，您可以通過以下方式進行檢查：

1. **檢查 HTTP 標頭**：查看 HTTP 請求的標頭信息。通常，反向代理會在標頭中添加一些特定的標誌或標頭字段，以指示請求是通過反向代理發送的。例如，您可以檢查 `Via`、`X-Forwarded-For` 或 `X-Real-IP` 等標頭字段。

2. **分析 IP 地址**：查看請求中的 IP 地址。如果所有來自對方的請求都來自同一個或一組 IP 地址，這可能表明他們使用了反向代理。您可以查詢這些 IP 地址的歸屬地和性質，以確定它們是否屬於反向代理服務器。

3. **端口掃描**：如果您能夠進行端口掃描，可以查看對方服務器上是否運行了常見的反向代理服務器軟件，例如 Nginx、Apache、HAProxy 等。這可能表明他們正在使用反向代理。

4. **通過 DNS 查詢**：查詢對方網站的 DNS 記錄，檢查是否存在反向代理服務器的相關信息，例如 CNAME 記錄或指向反向代理的 A 記錄。

5. **請求追蹤**：對於特定的請求，您可以在網絡層面追蹤其路徑，以查看是否通過了反向代理服務器。這可能需要使用特殊的工具或技術，例如 tracert（Windows）或 traceroute（Linux）。

綜合使用這些方法可以幫助您確定對方是否使用了反向代理。




## 重點:
Via 头部通常会出现在 HTTP 请求和响应中，但它们的出现情况略有不同：

请求中的 Via 头部：

当请求经过一个或多个代理服务器时，每个代理服务器都会将自己的信息添加到请求头部的 Via 字段中。因此，Via 头部会出现在 HTTP 请求中，并记录了请求的传输路径。
响应中的 Via 头部：

当响应经过一个或多个代理服务器时，每个代理服务器都会将自己的信息添加到响应头部的 Via 字段中。因此，Via 头部也会出现在 HTTP 响应中，并记录了响应的传输路径。
因此，无论是请求还是响应，如果它们经过了一个或多个代理服务器，都有可能包含 Via 头部。






## CDN

教學影片:
https://www.youtube.com/watch?v=m73oA0_ptxc

https://www.youtube.com/watch?v=HYZdRvekH04


CDN 的工作原理如下：

1. **内容缓存**：CDN会在其服务器节点上缓存网站的静态和动态内容，例如图片、CSS、JavaScript、视频等。这些内容会被复制到全球各地的CDN节点上。

2. **全球分发**：CDN节点分布在全球各地的数据中心和网络中，以接近用户的位置。当用户发起请求时，CDN会根据用户的位置选择最近的节点，从而减少网络延迟和传输时间。

3. **负载均衡**：CDN会根据网络流量和服务器负载情况，动态地将用户请求分发到不同的服务器节点上，从而避免单个服务器负载过重。

4. **缓存策略**：CDN节点可以根据内容类型、大小、更新频率等因素，制定不同的缓存策略。静态内容通常被缓存更长时间，而动态内容则根据需要进行更新。

5. **安全性**：CDN可以提供安全功能，例如DDoS攻击防护、SSL加密、内容签名等，从而保护网站免受恶意攻击和数据泄露。


### 網站與 CDN 整合時，通常會使用 CNAME 記錄
將網站與 CDN 整合時，通常會使用 CNAME 記錄（別名記錄）來設定 DNS。CNAME 記錄允許你將一個網域名稱指向另一個網域名稱，這正是將網站指向 CDN 所需的。通过設置 CNAME 記錄，你可以將你的網站的子域名（例如 www）指向 CDN 提供的 CDN 域名。

例如，如果 CDN 提供的 CDN 域名是 `cdn.example.com`，而你的網站是 `www.example.com`，則你可以創建一個 CNAME 記錄，將 `www.example.com` 指向 `cdn.example.com`。

這樣當用戶訪問你的網站時，他們的瀏覽器會通過 CDN 域名載入網站內容，CDN 服務將負責將請求轉發到最近的 CDN 伺服器，以提高網站的速度和性能。



![image](https://hackmd.io/_uploads/ByB04hITp.png)



## 常見架構

假設我有一台反向代理nginx 然後我想均衡附載兩台web伺服器
我一共要申請多少IP?


如果您想要使用反向代理（NGINX）来负载均衡两台Web服务器，您只需要一个公共IP地址用于NGINX服务器。NGINX可以监听该IP地址并根据配置将流量分发到两台Web服务器。

您可以按照以下步骤操作：

1. 将您的域名指向您NGINX服务器的公共IP地址。
2. 在NGINX配置中设置负载均衡规则，以确保流量被平均分发到两台Web服务器。
3. 确保两台Web服务器能够通过内部网络或专用IP地址访问。

因此，您只需要一个公共IP地址即可实现反向代理负载均衡。


- 但其實两台Web服务器。也可以為公共IP


![image](https://hackmd.io/_uploads/rk1ZMtNT6.png)

![image](https://hackmd.io/_uploads/Byhcyoc6T.png)

* 詳細說明
https://blog.51cto.com/u_15303040/3088415

### 還可以加上CDN

![image](https://hackmd.io/_uploads/Syv2fKET6.png)






### 還可以再 cdn + 多台负载均衡 

https://dashen.wang/5496.html

https://juejin.cn/post/7263858148276453431


```
Internet
 │
┌─────────┐          ┌─────────┐
│ CDN 节点 │───────▶│ 负载均衡 │
└─────────┘          └─────────┘
   │   │                  │   │
   ▼   ▼                  ▼   ▼
┌─────────┐          ┌─────────┐
│ 负载均衡 │          │ 负载均衡 │
└─────────┘          └─────────┘
   │   │                  │   │
   ▼   ▼                  ▼   ▼
┌─────────┐          ┌─────────┐
│ Web 服务器 │         │ Web 服务器 │
└─────────┘          └─────────┘
```

在这个调整后的架构中，CDN节点仅连接到负载均衡服务器，不直接连接到Web服务器。多个负载均衡服务器负责接收来自CDN节点的请求，并根据负载均衡算法将请求分发给内部的Web服务器。这种设置确保了CDN节点无法直接访问Web服务器，而是通过负载均衡服务器进行访问。




当您向您的域名服务商添加多个A记录时，每个A记录都将对应一个IP地址，这些IP地址可能指向您的负载均衡器或CDN节点。下面是一般情况下的流程：

1. **添加多个A记录**：首先，在您的域名服务商的控制面板中，添加多个A记录，每个A记录对应一个IP地址。这些IP地址可以是您的负载均衡器的IP地址或CDN节点的IP地址。

2. **负载均衡器**：如果您选择将A记录指向负载均衡器，那么这些记录将使流量平均分配到您的多个Web服务器上。您的负载均衡器将根据其负载均衡算法将请求转发到内部的Web服务器上。

3. **CDN节点**：如果您选择将A记录指向CDN节点，那么这些记录将使请求通过CDN网络。CDN节点通常会缓存静态内容，并将动态内容请求转发到负载均衡器或您的源服务器。这样可以提高内容的传输速度和全球分发。

4. **DNS解析**：一旦您的A记录添加到了您的域名服务商的DNS配置中，全球各地的DNS服务器会开始解析这些记录。用户访问您的网站时，他们的浏览器会向最接近的DNS服务器发起解析请求，并获取到最新的IP地址。

5. **请求处理**：当用户访问您的网站时，请求会被发送到与A记录关联的IP地址（负载均衡器或CDN节点）。负载均衡器或CDN节点将请求转发到内部的Web服务器上，并返回响应给用户。

通过添加多个A记录并与负载均衡器或CDN节点配合使用，您可以提高网站的可用性、性能和安全性，以及全球范围内的内容分发。





## 善用 telnet  nmap 之類的檢查banner 確認是否代理

```
telnet 52.117.224.147 80

Trying 52.117.224.147...
Connected to 52.117.224.147.
Escape character is '^]'.

a
HTTP/1.0 400 Bad Request
Server: squid
Date: Wed, 06 Mar 2024 13:48:05 GMT
Content-Type: text/html
Content-Length: 1146
Expires: Wed, 06 Mar 2024 13:48:05 GMT
X-Squid-Error: ERR_INVALID_REQ 0
X-Cache: MISS from eyny.com
X-Cache-Lookup: NONE from eyny.com:80
Via: 1.0 eyny.com:80 (squid)
Proxy-Connection: close


```


- Telnet 不会触发代理服务器的行为，因为它只是在 TCP 层面建立连接，并发送原始数据。Telnet 不会发送 HTTP 请求，也不会包含 HTTP 头部等信息，因此代理服务器通常不会对 Telnet 进行处理或转发。



- Squid 代理通常会在 HTTP 层面进行转发，而不是在 TCP 端口层面进行转发。


## 轉發與錯誤頁面

当客户端发送 HTTP 请求时，Squid 代理会解析这些请求，并根据请求的 URL、头部信息等来做出转发决策。它会根据配置的规则和策略，将请求转发到适当的目标服务器，并将服务器的响应返回给客户端。在这个过程中，Squid 代理会处理 HTTP 协议的细节，例如解析头部、修改请求、缓存内容等。

因此，Squid 代理通常是在 HTTP 层面进行操作和转发的，而不是简单地在 TCP 端口层面进行转发。



Nginx也通常在HTTP层面进行转发。Nginx是一个高性能的HTTP服务器和反向代理服务器，它可以接收客户端的HTTP请求，根据配置的规则和策略，将请求转发到适当的目标服务器，并将目标服务器的响应返回给客户端。

Nginx可以通过配置文件中的反向代理指令来设置代理服务器，如proxy_pass。通过这些指令，Nginx可以根据HTTP请求的URL、头部信息等来做出转发决策，并将请求转发到指定的后端服务器。在这个过程中，Nginx会解析HTTP协议的细节，例如解析请求头部、修改请求、处理响应等




Nginx 和 Squid 都可以生成自定义的错误页面，并且在某些情况下不需要经过转发。例如，当客户端发送一个无效的请求时，或者请求无法被处理时，Nginx 和 Squid 可以直接生成错误页面作为响应返回给客户端，而无需将请求转发到后端的服务器。

这种情况下，Nginx 和 Squid 可以在代理服务器本身处理请求时，生成错误页面并直接返回给客户端。这样可以节省资源和时间，因为不需要将请求转发到后端服务器，并且能够更快地向客户端提供错误信息。







## VPN 


https://www.youtube.com/watch?v=YJpXi6d5oKM